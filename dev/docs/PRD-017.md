# PRD-017: Polish & Reliability

**Version**: 1.0
**Date**: 2025-12-01
**Phase**: 6 - Production Hardening
**Status**: Completed (2025-12-02)

---

## Objective

Address remaining issues from production readiness review: version consistency, dependency cleanup, basic agent tests, database backups, timezone handling, and frontend polish. These are lower priority but improve overall reliability and maintainability.

**Priority**: P2 - Medium (Polish)

---

## Background

Multiple reviews identified non-critical but important improvements:
1. Version string mismatch (0.1.0 vs 1.0.0)
2. Duplicate MCP dependency in requirements.txt
3. Minimal test coverage for AI agents
4. No database backup strategy
5. UsageLimiter uses server timezone (UTC on Railway)
6. Frontend has unimplemented TODO buttons
7. Outdated Anthropic SDK version
8. Dashboard entry point ambiguity (index.html vs simple.html)

---

## Success Criteria

- [ ] Version updated to 1.0.0 across all files
- [ ] Duplicate dependencies removed from requirements.txt
- [ ] Basic agent tests with mocked Claude responses
- [ ] Database backup script created and documented
- [ ] UsageLimiter timezone explicitly set
- [ ] Frontend TODO buttons removed or implemented
- [ ] Anthropic SDK updated to latest stable
- [ ] Dashboard navigation unified (index.html as entry point)
- [ ] Unused stub files cleaned up (claude_api.py)
- [ ] Health check uses SQLAlchemy text()
- [ ] Logging configuration centralized
- [ ] Selenium cleanup handlers added
- [ ] All tests passing

---

## Technical Specifications

### Part A: Version Consistency

**Files to Update**:

1. `backend/app.py` line 24:
```python
# Before
app = FastAPI(title="Macro Confluence Hub", version="0.1.0")

# After
app = FastAPI(title="Macro Confluence Hub", version="1.0.0")
```

2. `mcp_server/config.py`:
```python
SERVER_VERSION = "1.0.0"
```

3. Verify `pyproject.toml` or `setup.py` if they exist

### Part B: Dependency Cleanup

**File**: `requirements.txt`

**Issue**: `mcp>=1.0.0` appears twice (lines 44 and 53)

**Fix**: Remove duplicate, keep single entry with appropriate version constraint

**Also**: Update outdated packages
```txt
# Before
anthropic==0.18.1

# After
anthropic>=0.40.0,<1.0.0
```

### Part C: Basic Agent Tests

**Goal**: Add tests that mock Claude API responses to verify agent parsing logic.

**New File**: `tests/test_agents/test_confluence_scorer.py`

```python
"""
Tests for ConfluenceScorerAgent.

Uses mocked Claude responses to test parsing logic without API calls.
"""

import pytest
from unittest.mock import patch, MagicMock
from agents.confluence_scorer import ConfluenceScorerAgent


# Sample Claude response for testing
MOCK_CLAUDE_RESPONSE = {
    "pillar_scores": {
        "macro": 2,
        "fundamentals": 1,
        "valuation": 1,
        "positioning": 2,
        "policy": 1,
        "price_action": 1,
        "options_vol": 0
    },
    "core_total": 6,
    "total_score": 8,
    "meets_threshold": True,
    "confluence_level": "medium",
    "primary_thesis": "Fed pivot trade",
    "falsification_criteria": ["CPI > 4%", "Fed hawkish rhetoric"]
}


@pytest.fixture
def scorer():
    """Create scorer with mocked API key."""
    with patch.dict('os.environ', {'CLAUDE_API_KEY': 'test-key'}):
        return ConfluenceScorerAgent()


def test_score_content_parsing(scorer):
    """Test that scorer correctly parses Claude response."""
    with patch.object(scorer, 'call_claude', return_value=MOCK_CLAUDE_RESPONSE):
        result = scorer.analyze({"content": "test content"})

    assert result["total_score"] == 8
    assert result["meets_threshold"] == True
    assert result["pillar_scores"]["macro"] == 2


def test_score_validation(scorer):
    """Test that scorer validates required fields."""
    invalid_response = {"partial": "data"}

    with patch.object(scorer, 'call_claude', return_value=invalid_response):
        with pytest.raises(ValueError):
            scorer.analyze({"content": "test"})


def test_threshold_calculation(scorer):
    """Test threshold logic (>=7 core_total meets threshold)."""
    # Test cases for threshold boundary
    test_cases = [
        ({"core_total": 6}, False),
        ({"core_total": 7}, True),
        ({"core_total": 8}, True),
    ]

    for response_data, expected in test_cases:
        full_response = {**MOCK_CLAUDE_RESPONSE, **response_data}
        full_response["meets_threshold"] = expected

        with patch.object(scorer, 'call_claude', return_value=full_response):
            result = scorer.analyze({"content": "test"})
            assert result["meets_threshold"] == expected
```

**New File**: `tests/test_agents/test_synthesis_agent.py`

```python
"""
Tests for SynthesisAgent.

Uses mocked Claude responses to test synthesis logic.
"""

import pytest
from unittest.mock import patch
from agents.synthesis_agent import SynthesisAgent


MOCK_SYNTHESIS_RESPONSE = {
    "synthesis": "Markets showing risk-on sentiment...",
    "key_themes": ["Fed pivot", "Tech rotation"],
    "high_conviction_ideas": [
        {"idea": "Long gold", "sources": ["42macro"], "confidence": "high"}
    ],
    "contradictions": [],
    "market_regime": "risk-on",
    "catalysts": ["FOMC meeting"]
}


@pytest.fixture
def agent():
    with patch.dict('os.environ', {'CLAUDE_API_KEY': 'test-key'}):
        return SynthesisAgent()


def test_synthesis_generation(agent):
    """Test synthesis generates expected structure."""
    content_items = [
        {"source": "42macro", "summary": "Bullish on gold", "themes": ["gold"]}
    ]

    with patch.object(agent, 'call_claude', return_value=MOCK_SYNTHESIS_RESPONSE):
        result = agent.analyze(content_items, time_window="24h")

    assert "synthesis" in result
    assert "key_themes" in result
    assert result["time_window"] == "24h"


def test_empty_content_handling(agent):
    """Test synthesis handles empty content gracefully."""
    result = agent.analyze([], time_window="24h")

    assert result["content_count"] == 0
    assert "No content" in result["synthesis"]
```

### Part D: Database Backup Script

**New File**: `scripts/backup_db.py`

```python
#!/usr/bin/env python3
"""
Database Backup Script

Creates timestamped backups of the SQLite database.
Keeps last N backups (configurable).

Usage:
    python scripts/backup_db.py

Can be scheduled via cron/Task Scheduler for regular backups.
"""

import shutil
import logging
from datetime import datetime
from pathlib import Path

# Configuration
DB_PATH = Path("database/confluence.db")
BACKUP_DIR = Path("backups")
MAX_BACKUPS = 4  # Keep last 4 backups (1 month if weekly)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def backup_database():
    """Create timestamped backup of database."""
    if not DB_PATH.exists():
        logger.error(f"Database not found: {DB_PATH}")
        return False

    # Create backup directory
    BACKUP_DIR.mkdir(parents=True, exist_ok=True)

    # Generate timestamped filename
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = BACKUP_DIR / f"confluence_{timestamp}.db"

    # Copy database
    try:
        shutil.copy2(DB_PATH, backup_path)
        size_mb = backup_path.stat().st_size / (1024 * 1024)
        logger.info(f"Backup created: {backup_path} ({size_mb:.2f} MB)")
    except Exception as e:
        logger.error(f"Backup failed: {e}")
        return False

    # Rotate old backups
    rotate_backups()

    return True


def rotate_backups():
    """Remove old backups, keeping only MAX_BACKUPS most recent."""
    backups = sorted(BACKUP_DIR.glob("confluence_*.db"))

    if len(backups) > MAX_BACKUPS:
        for old_backup in backups[:-MAX_BACKUPS]:
            logger.info(f"Removing old backup: {old_backup}")
            old_backup.unlink()


def list_backups():
    """List all existing backups."""
    backups = sorted(BACKUP_DIR.glob("confluence_*.db"))

    if not backups:
        logger.info("No backups found")
        return

    logger.info(f"Found {len(backups)} backups:")
    for backup in backups:
        size_mb = backup.stat().st_size / (1024 * 1024)
        logger.info(f"  {backup.name} ({size_mb:.2f} MB)")


def restore_backup(backup_name: str):
    """
    Restore database from backup.

    Args:
        backup_name: Name of backup file (e.g., 'confluence_20251201_120000.db')
    """
    backup_path = BACKUP_DIR / backup_name

    if not backup_path.exists():
        logger.error(f"Backup not found: {backup_path}")
        return False

    # Create backup of current DB before restore
    if DB_PATH.exists():
        pre_restore = DB_PATH.with_suffix(".db.pre_restore")
        shutil.copy2(DB_PATH, pre_restore)
        logger.info(f"Current DB backed up to: {pre_restore}")

    # Restore
    shutil.copy2(backup_path, DB_PATH)
    logger.info(f"Database restored from: {backup_path}")
    return True


if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1:
        command = sys.argv[1]
        if command == "list":
            list_backups()
        elif command == "restore" and len(sys.argv) > 2:
            restore_backup(sys.argv[2])
        else:
            print("Usage: python backup_db.py [list|restore <backup_name>]")
    else:
        backup_database()
```

### Part E: UsageLimiter Timezone Fix

**File**: `backend/utils/usage_limiter.py`

**Issue**: `date.today()` uses server timezone (UTC on Railway), which may reset at unexpected local time.

**Fix**: Explicitly use UTC for consistency

```python
from datetime import datetime, timezone

def _get_today_utc() -> str:
    """Get today's date in UTC (YYYY-MM-DD)."""
    return datetime.now(timezone.utc).strftime("%Y-%m-%d")

# Replace all date.today() calls with _get_today_utc()
```

Add documentation explaining the timezone behavior.

### Part F: Frontend Cleanup

**File**: `frontend/index.html`

**Issue**: Lines 288 and 319 have TODO comments for unimplemented buttons.

**Options**:
1. **Remove buttons** - Simplest, removes non-functional UI
2. **Implement buttons** - Connect to new trigger endpoints from PRD-014

**Recommendation**: Implement buttons since PRD-014 creates the trigger endpoints.

```javascript
// Line 288 - Replace TODO with actual implementation
async function triggerCollection() {
    const response = await fetch('/api/trigger/collect', {
        method: 'POST',
        headers: {
            'Authorization': 'Basic ' + btoa(username + ':' + password)
        }
    });
    if (response.ok) {
        showNotification('Collection started!', 'success');
    } else {
        showNotification('Failed to start collection', 'error');
    }
}
```

### Part G: Dashboard Uniformity

**Issue**: Both `index.html` and `simple.html` exist. Need clear entry point.

**Decision**: Keep `index.html` as the main entry point.

**Actions**:
1. Ensure `index.html` is the comprehensive dashboard
2. If `simple.html` has unique features, merge into `index.html`
3. Remove or rename `simple.html` to avoid confusion
4. Update all internal navigation links

### Part H: Code Cleanup (Minor Issues)

**Issues identified in review but not critical:**

#### H.1: Selenium Process Cleanup
**File**: `collectors/macro42_selenium.py`

Add explicit Chrome process cleanup on hard crash:
```python
import atexit
import signal

def cleanup_chrome():
    """Kill any orphaned Chrome processes."""
    try:
        if hasattr(self, 'driver') and self.driver:
            self.driver.quit()
    except:
        pass

atexit.register(cleanup_chrome)
```

#### H.2: Remove Unused claude_api.py Stub
**File**: `backend/utils/claude_api.py`

This file contains only TODOs and is unused. Either:
- Delete it entirely, OR
- Implement it if needed for future use

**Recommendation**: Delete since agents use their own Claude client.

#### H.3: Health Check SQL Modernization
**File**: `backend/app.py` (line ~79)

**Current**:
```python
db.execute("SELECT 1")  # Raw string
```

**Target** (SQLAlchemy 2.0 compatible):
```python
from sqlalchemy import text
db.execute(text("SELECT 1"))
```

#### H.4: Logging Configuration
**File**: `agents/base_agent.py` (line 17)

**Issue**: `logging.basicConfig()` can conflict with uvicorn's logging.

**Fix**: Remove basicConfig call; let app.py configure logging centrally:
```python
# In base_agent.py - just get logger, don't configure
logger = logging.getLogger(__name__)

# In app.py - configure logging once at startup
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

---

## Implementation Tasks

### Task 17.1: Update Version Numbers
**Estimate**: 15 minutes

**Actions**:
1. Update `backend/app.py` version to "1.0.0"
2. Update `mcp_server/config.py` version to "1.0.0"
3. Search for other version strings and update
4. Verify consistency

### Task 17.2: Clean Up Dependencies
**Estimate**: 30 minutes

**Actions**:
1. Remove duplicate `mcp>=1.0.0` from requirements.txt
2. Update `anthropic` to `>=0.40.0,<1.0.0`
3. Review other outdated packages
4. Run `pip install -r requirements.txt` to verify
5. Test that app still starts

### Task 17.3: Add Agent Tests
**Estimate**: 2 hours

**Actions**:
1. Create `tests/test_agents/test_confluence_scorer.py`
2. Create `tests/test_agents/test_synthesis_agent.py`
3. Add mock fixtures for Claude responses
4. Test parsing and validation logic
5. Run pytest to verify

### Task 17.4: Create Backup Script
**Estimate**: 1 hour

**Actions**:
1. Create `scripts/backup_db.py`
2. Test backup creation
3. Test rotation (keeps last 4)
4. Test restore functionality
5. Add `backups/` to `.gitignore`
6. Document usage in README

### Task 17.5: Fix UsageLimiter Timezone
**Estimate**: 30 minutes

**Actions**:
1. Update `backend/utils/usage_limiter.py` to use UTC
2. Add helper function `_get_today_utc()`
3. Document timezone behavior
4. Test date rollover logic

### Task 17.6: Implement Frontend Buttons
**Estimate**: 1 hour

**Actions**:
1. Update `frontend/index.html` trigger button handlers
2. Connect to `/api/trigger/collect` endpoint
3. Connect to `/api/trigger/analyze` endpoint
4. Add loading states and notifications
5. Test end-to-end

### Task 17.7: Unify Dashboard
**Estimate**: 1 hour

**Actions**:
1. Compare `index.html` and `simple.html` features
2. Merge any unique features into `index.html`
3. Remove or archive `simple.html`
4. Update navigation links across all HTML files
5. Test navigation flow

### Task 17.8: Code Cleanup (Part H)
**Estimate**: 1 hour

**Actions**:
1. Add Selenium atexit cleanup handler to `macro42_selenium.py`
2. Delete `backend/utils/claude_api.py` stub file
3. Update health check to use `text("SELECT 1")`
4. Centralize logging config in `app.py`, remove from `base_agent.py`
5. Test that all components still work

### Task 17.9: Final Testing & Documentation
**Estimate**: 1 hour

**Actions**:
1. Run full test suite
2. Manual testing of all changes
3. Update README with backup instructions
4. Update CHANGELOG with version 1.0.0 final notes

---

## Testing Plan

### Unit Tests
- Agent parsing with mocked responses
- UsageLimiter timezone handling
- Backup script rotation logic

### Integration Tests
- Frontend buttons trigger API correctly
- Backup and restore flow

### Manual Tests
- Click all dashboard buttons
- Verify version displayed correctly
- Run backup script
- Test navigation between pages

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Anthropic SDK update breaks code | Medium | Test thoroughly; pin to specific version if needed |
| Agent tests too brittle | Low | Use flexible assertions; focus on structure not content |
| Dashboard merge loses features | Low | Careful comparison; keep backup of simple.html |

---

## Dependencies

- PRD-014 (trigger endpoints for frontend buttons)
- PRD-015 (auth for frontend buttons)

---

## Files Modified/Created

**New Files**:
- `scripts/backup_db.py`
- `tests/test_agents/test_confluence_scorer.py`
- `tests/test_agents/test_synthesis_agent.py`

**Modified Files**:
- `backend/app.py` (version update, health check fix, logging config)
- `mcp_server/config.py` (version update)
- `requirements.txt` (dependency cleanup)
- `backend/utils/usage_limiter.py` (timezone fix)
- `frontend/index.html` (implement buttons, merge simple.html)
- `collectors/macro42_selenium.py` (Selenium cleanup handlers)
- `agents/base_agent.py` (remove basicConfig call)
- `.gitignore` (add backups/)
- `README.md` (backup documentation)
- `CHANGELOG.md` (version 1.0.0 notes)

**Files Removed**:
- `frontend/simple.html` (merged into index.html)
- `backend/utils/claude_api.py` (unused stub)

---

## Sign-off

**Developer**: ___________  Date: ___________
**Sebastian**: ___________  Date: ___________

---

**Status**: Planning
