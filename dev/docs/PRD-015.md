# PRD-015: Security Hardening

**Version**: 1.0
**Date**: 2025-12-01
**Phase**: 6 - Production Hardening
**Status**: Planning

---

## Objective

Implement security best practices to protect the application and its data. This includes adding authentication, API rate limiting, removing hardcoded secrets, and fixing insecure data handling patterns.

**Priority**: P1 - High (Security)

---

## Background

Security review identified several issues:
1. No authentication on dashboard or API endpoints
2. No rate limiting - API abuse could exhaust Claude budget
3. Discord channel IDs hardcoded in version-controlled config file
4. Hardcoded Railway URLs in collector code
5. Pickle used for cookie storage (arbitrary code execution risk)

---

## Success Criteria

- [ ] HTTP Basic Auth protects all dashboard and API routes
- [ ] Health check endpoint remains public (for Railway)
- [ ] API rate limiting prevents abuse (configurable limits)
- [ ] Discord channel IDs moved to environment variables
- [ ] All hardcoded URLs replaced with environment variables
- [ ] Pickle replaced with JSON for cookie storage
- [ ] Security changes documented
- [ ] Existing functionality unchanged

---

## Technical Specifications

### Part A: HTTP Basic Authentication

**Implementation Strategy**: FastAPI middleware with configurable credentials

**File**: `backend/utils/auth.py` (replace stub)

```python
import os
import secrets
from fastapi import HTTPException, Security, status
from fastapi.security import HTTPBasic, HTTPBasicCredentials

security = HTTPBasic()

# Credentials from environment
AUTH_USERNAME = os.getenv("AUTH_USERNAME", "admin")
AUTH_PASSWORD = os.getenv("AUTH_PASSWORD")  # Required in production

def verify_credentials(credentials: HTTPBasicCredentials = Security(security)):
    """
    Verify HTTP Basic Auth credentials.

    Raises HTTPException if invalid.
    """
    if not AUTH_PASSWORD:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="AUTH_PASSWORD not configured"
        )

    # Use secrets.compare_digest to prevent timing attacks
    username_correct = secrets.compare_digest(
        credentials.username.encode("utf8"),
        AUTH_USERNAME.encode("utf8")
    )
    password_correct = secrets.compare_digest(
        credentials.password.encode("utf8"),
        AUTH_PASSWORD.encode("utf8")
    )

    if not (username_correct and password_correct):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid credentials",
            headers={"WWW-Authenticate": "Basic"},
        )

    return credentials.username
```

**Application**: Add dependency to protected routes

```python
# In app.py or individual route files
from backend.utils.auth import verify_credentials

@app.get("/api/dashboard/today")
async def get_today(user: str = Depends(verify_credentials)):
    # ... existing code
```

**Public Endpoints** (no auth required):
- `GET /health` - Railway health check
- `GET /` - Static frontend files (auth handled by browser prompt)

### Part B: API Rate Limiting

**Library**: `slowapi` (built on `limits`)

**File**: `backend/utils/rate_limiter.py`

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

# Rate limiter instance
limiter = Limiter(key_func=get_remote_address)

# Rate limit configurations
RATE_LIMITS = {
    "default": "100/minute",
    "synthesis": "10/hour",      # Expensive Claude calls
    "trigger": "5/hour",         # Collection triggers
    "search": "60/minute",       # Database queries
}
```

**Application in routes**:
```python
from backend.utils.rate_limiter import limiter, RATE_LIMITS

@router.post("/generate")
@limiter.limit(RATE_LIMITS["synthesis"])
async def generate_synthesis(request: Request, ...):
    # ...
```

### Part C: Discord Channel IDs to Environment

**Current Location**: `config/discord_channels.json`

**Target**: Environment variable with JSON parsing

**Changes**:

1. Add to `.env.example`:
```bash
# Discord Configuration (JSON format)
DISCORD_CHANNELS='{"servers": [{"name": "Options Insight", "id": "905153459874066462", "channels": [...]}]}'
```

2. Modify loader in `collectors/discord_self.py`:
```python
import os
import json

def load_discord_config():
    """Load Discord channel config from environment or file."""
    env_config = os.getenv("DISCORD_CHANNELS")
    if env_config:
        return json.loads(env_config)

    # Fallback to file for local development only
    config_path = Path("config/discord_channels.json")
    if config_path.exists():
        return json.loads(config_path.read_text())

    raise ValueError("Discord configuration not found")
```

3. Add `config/discord_channels.json` to `.gitignore`

4. Create `config/discord_channels.example.json` with placeholder IDs

### Part D: Remove Hardcoded URLs

**Affected File**: `collectors/discord_self.py`

**Current** (lines 687, 775):
```python
response = requests.post(
    "https://confluence-production.up.railway.app/api/heartbeat/discord",
    ...
)
```

**Target**:
```python
RAILWAY_API_URL = os.getenv("RAILWAY_API_URL", "http://localhost:8000")

response = requests.post(
    f"{RAILWAY_API_URL}/api/heartbeat/discord",
    ...
)
```

### Part E: Replace Pickle with JSON for Cookies

**Affected File**: `collectors/macro42_selenium.py`

**Current** (lines 247-270):
```python
import pickle

def _save_cookies(self):
    with open(self.COOKIES_FILE, 'wb') as f:
        pickle.dump(cookies, f)

def _load_cookies(self):
    with open(self.COOKIES_FILE, 'rb') as f:
        cookies = pickle.load(f)
```

**Target**:
```python
import json

def _save_cookies(self):
    """Save current browser cookies to JSON file."""
    try:
        cookies = self.driver.get_cookies()
        # Remove non-serializable fields
        for cookie in cookies:
            cookie.pop('expiry', None)  # Sometimes a float
            cookie.pop('sameSite', None)  # Can cause issues

        with open(self.COOKIES_FILE, 'w') as f:
            json.dump(cookies, f, indent=2)
        logger.info(f"Saved {len(cookies)} cookies to {self.COOKIES_FILE}")
    except Exception as e:
        logger.error(f"Failed to save cookies: {e}")

def _load_cookies(self):
    """Load cookies from JSON file into browser."""
    try:
        self.driver.get(self.BASE_URL)

        with open(self.COOKIES_FILE, 'r') as f:
            cookies = json.load(f)

        for cookie in cookies:
            self.driver.add_cookie(cookie)

        logger.info(f"Loaded {len(cookies)} cookies from {self.COOKIES_FILE}")
    except Exception as e:
        logger.error(f"Failed to load cookies: {e}")
```

Also update `COOKIES_FILE` extension:
```python
COOKIES_FILE = "temp/42macro_cookies.json"  # Was .pkl
```

---

## Implementation Tasks

### Task 15.1: Implement HTTP Basic Auth
**Estimate**: 1-2 hours

**Actions**:
1. Replace `backend/utils/auth.py` stub with full implementation
2. Add `verify_credentials` dependency to all API routes
3. Exclude `/health` from authentication
4. Add `AUTH_USERNAME` and `AUTH_PASSWORD` to `.env.example`
5. Test authentication flow
6. Document credentials setup

### Task 15.2: Add API Rate Limiting
**Estimate**: 1-2 hours

**Actions**:
1. Add `slowapi` to `requirements.txt`
2. Create `backend/utils/rate_limiter.py`
3. Apply rate limits to expensive endpoints (synthesis, trigger)
4. Apply default limits to other endpoints
5. Add rate limit headers to responses
6. Test rate limiting behavior
7. Document rate limits in API docs

### Task 15.3: Move Discord Config to Environment
**Estimate**: 1 hour

**Actions**:
1. Update `collectors/discord_self.py` config loader
2. Add `DISCORD_CHANNELS` to `.env.example` with instructions
3. Create `config/discord_channels.example.json`
4. Add `config/discord_channels.json` to `.gitignore`
5. Update Railway environment variables
6. Test Discord collector with env-based config

### Task 15.4: Remove Hardcoded URLs
**Estimate**: 30 minutes

**Actions**:
1. Search codebase for hardcoded Railway URLs
2. Replace with `os.getenv("RAILWAY_API_URL")`
3. Add `RAILWAY_API_URL` to `.env.example`
4. Update local `.env` files
5. Test heartbeat functionality

### Task 15.5: Replace Pickle with JSON
**Estimate**: 30 minutes

**Actions**:
1. Update `collectors/macro42_selenium.py` cookie methods
2. Change file extension from `.pkl` to `.json`
3. Delete any existing `.pkl` cookie files (in `.gitignore`)
4. Test 42 Macro collector login flow
5. Verify cookies load correctly on restart

### Task 15.6: Security Documentation
**Estimate**: 30 minutes

**Actions**:
1. Update README security section
2. Document authentication setup
3. Document rate limits
4. Add security considerations to deployment guide

---

## Testing Plan

### Unit Tests
- Auth credential verification (valid/invalid)
- Rate limiter triggering
- Discord config loader (env vs file fallback)
- Cookie save/load with JSON

### Integration Tests
- Authenticated API requests
- Unauthenticated requests rejected (401)
- Rate limit exceeded (429)
- Health check accessible without auth

### Manual Tests
- Browser login prompt appears
- Credentials work correctly
- Rate limits trigger after threshold
- Discord collector works with env config
- 42 Macro collector works with JSON cookies

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Auth breaks existing workflows | High | Test thoroughly before deploy; document credentials |
| Rate limits too restrictive | Medium | Start with generous limits; make configurable |
| Discord config migration fails | Medium | Keep file fallback for local dev |
| Cookie migration corrupts session | Low | Delete old cookies; fresh login required |

---

## Dependencies

- PRD-014 (environment variable infrastructure)
- `slowapi` package

---

## Environment Variables Added

| Variable | Description | Required |
|----------|-------------|----------|
| `AUTH_USERNAME` | HTTP Basic Auth username | Yes (production) |
| `AUTH_PASSWORD` | HTTP Basic Auth password | Yes (production) |
| `RAILWAY_API_URL` | Base URL for Railway deployment | Yes (production) |
| `DISCORD_CHANNELS` | JSON config for Discord channels | Yes (if using Discord) |

---

## Files Modified/Created

**New Files**:
- `backend/utils/rate_limiter.py`
- `config/discord_channels.example.json`

**Modified Files**:
- `backend/utils/auth.py` (replace stub with implementation)
- `backend/app.py` (add auth middleware, rate limiter)
- `backend/routes/*.py` (add auth dependency)
- `collectors/discord_self.py` (env config, remove hardcoded URLs)
- `collectors/macro42_selenium.py` (JSON cookies)
- `.env.example` (new variables)
- `.gitignore` (add discord_channels.json, .pkl files)
- `requirements.txt` (add slowapi)
- `README.md` (security documentation)

---

## Sign-off

**Developer**: ___________  Date: ___________
**Sebastian**: ___________  Date: ___________

---

**Status**: Planning
