# PRD-016: MCP Server API Proxy Refactor

**Version**: 1.0
**Date**: 2025-12-01
**Phase**: 6 - Production Hardening
**Status**: Planning

---

## Objective

Refactor the MCP Server to fetch data via HTTP API calls to the Railway deployment instead of directly querying a local SQLite database. This fixes the architecture gap where Claude Desktop (running locally) cannot access the production database (on Railway).

**Priority**: P1 - High (Feature Broken)

---

## Background

The current MCP Server implementation (PRD-013) connects directly to `database/confluence.db`. This works when:
- Both the MCP server and database are on the same machine
- Running in local development mode

This **does not work** when:
- The database is deployed to Railway (production)
- Claude Desktop runs locally but needs production data

**Solution**: Convert MCP tools to be thin API clients that call the existing Railway API endpoints.

---

## Success Criteria

- [ ] MCP Server fetches data from Railway API, not local SQLite
- [ ] All 5 MCP tools work with API proxy pattern
- [ ] Authentication supported (HTTP Basic Auth from PRD-015)
- [ ] Graceful error handling for network failures
- [ ] Local development mode still works (fallback to localhost)
- [ ] Claude Desktop configuration updated
- [ ] Response times acceptable (< 5 seconds per tool)

---

## Technical Specifications

### Architecture Change

**Before** (PRD-013):
```
Claude Desktop → MCP Server → SQLite (local file)
                                  ↓
                            Only works locally
```

**After** (PRD-016):
```
Claude Desktop → MCP Server → HTTP Client → Railway API → Database
                                                ↓
                                         Works anywhere
```

### Part A: API Client Module

**New File**: `mcp_server/api_client.py`

```python
"""
API Client for MCP Server

Fetches data from Railway API instead of local database.
"""

import os
import httpx
from typing import Optional, Dict, Any, List
from functools import lru_cache

# Configuration
API_BASE_URL = os.getenv("RAILWAY_API_URL", "http://localhost:8000")
API_USERNAME = os.getenv("AUTH_USERNAME", "admin")
API_PASSWORD = os.getenv("AUTH_PASSWORD", "")

# Timeout settings
REQUEST_TIMEOUT = 30.0  # seconds


class APIClient:
    """HTTP client for Railway API."""

    def __init__(self):
        self.base_url = API_BASE_URL.rstrip("/")
        self.auth = (API_USERNAME, API_PASSWORD) if API_PASSWORD else None

    def _request(
        self,
        method: str,
        endpoint: str,
        params: Optional[Dict] = None,
        json: Optional[Dict] = None
    ) -> Dict[str, Any]:
        """
        Make HTTP request to API.

        Raises:
            httpx.HTTPError: On network/HTTP errors
            ValueError: On invalid response
        """
        url = f"{self.base_url}{endpoint}"

        with httpx.Client(timeout=REQUEST_TIMEOUT) as client:
            response = client.request(
                method=method,
                url=url,
                params=params,
                json=json,
                auth=self.auth
            )
            response.raise_for_status()
            return response.json()

    def get(self, endpoint: str, params: Optional[Dict] = None) -> Dict[str, Any]:
        """GET request."""
        return self._request("GET", endpoint, params=params)

    def post(self, endpoint: str, json: Optional[Dict] = None) -> Dict[str, Any]:
        """POST request."""
        return self._request("POST", endpoint, json=json)


# Global client instance
api = APIClient()
```

### Part B: Tool Refactoring

Each tool in `mcp_server/tools/` will be refactored from direct SQLite queries to API calls.

#### Tool 1: `search.py`

**Before**:
```python
from mcp_server.database import db

def search_content(query: str, source: str = None, days: int = 7):
    results = db.execute_query(
        "SELECT * FROM raw_content WHERE content_text LIKE ?...",
        (f"%{query}%",)
    )
    return results
```

**After**:
```python
from mcp_server.api_client import api

def search_content(query: str, source: str = None, days: int = 7, limit: int = 10):
    """Search collected research content via API."""
    params = {
        "q": query,
        "days": days,
        "limit": limit
    }
    if source:
        params["source"] = source

    # Uses existing /api/dashboard/search or similar endpoint
    response = api.get("/api/search", params=params)
    return response
```

#### Tool 2: `synthesis.py`

**Before**:
```python
from mcp_server.database import db

def get_synthesis(time_window: str = "24h"):
    result = db.execute_one(
        "SELECT * FROM syntheses ORDER BY generated_at DESC LIMIT 1"
    )
    return result
```

**After**:
```python
from mcp_server.api_client import api

def get_synthesis(time_window: str = "24h"):
    """Get latest synthesis via API."""
    params = {"time_window": time_window} if time_window else {}
    response = api.get("/api/synthesis/latest", params=params)
    return response
```

#### Tool 3: `themes.py`

**After**:
```python
from mcp_server.api_client import api

def get_themes(active_only: bool = True, min_sources: int = 2):
    """Get tracked themes via API."""
    params = {
        "status": "active" if active_only else None,
        "min_sources": min_sources
    }
    response = api.get("/api/confluence/themes", params=params)
    return response.get("themes", [])
```

#### Tool 4: `recent.py`

**After**:
```python
from mcp_server.api_client import api

def get_recent(source: str, days: int = 3, content_type: str = None):
    """Get recent content from source via API."""
    params = {
        "days": days,
        "limit": 20
    }
    if content_type:
        params["content_type"] = content_type

    response = api.get(f"/api/dashboard/sources/{source}", params=params)
    return response.get("content", [])
```

#### Tool 5: `source_view.py`

**After**:
```python
from mcp_server.api_client import api

def get_source_view(source: str, topic: str = None):
    """Get source's view on topic via API."""
    # May need to call synthesis agent endpoint or search
    params = {"topic": topic} if topic else {}
    response = api.get(f"/api/sources/{source}/view", params=params)
    return response
```

### Part C: Configuration Updates

**File**: `mcp_server/config.py`

**Before**:
```python
DEFAULT_DB_PATH = Path(__file__).parent.parent / "database" / "confluence.db"
DATABASE_PATH = Path(os.getenv("DATABASE_PATH", str(DEFAULT_DB_PATH)))
```

**After**:
```python
# API Configuration (replaces local database)
API_BASE_URL = os.getenv("RAILWAY_API_URL", "http://localhost:8000")
AUTH_USERNAME = os.getenv("AUTH_USERNAME", "admin")
AUTH_PASSWORD = os.getenv("AUTH_PASSWORD", "")

# Server settings
SERVER_NAME = "confluence-hub"
SERVER_VERSION = "1.1.0"  # Bump version for API proxy

# Query limits
MAX_SEARCH_RESULTS = 50
DEFAULT_DAYS = 7
REQUEST_TIMEOUT = 30  # seconds
```

### Part D: Claude Desktop Configuration Update

**File**: `mcp_server/README.md` (update)

```json
{
  "mcpServers": {
    "confluence-hub": {
      "command": "python",
      "args": [
        "C:/path/to/confluence/mcp_server/server.py"
      ],
      "env": {
        "RAILWAY_API_URL": "https://confluence-production.up.railway.app",
        "AUTH_USERNAME": "admin",
        "AUTH_PASSWORD": "your-password-here"
      }
    }
  }
}
```

### Part E: Error Handling

All API calls should handle:
- Network timeouts
- Authentication failures (401)
- Server errors (500)
- API not reachable

```python
from mcp_server.api_client import api, APIError

def get_synthesis(time_window: str = "24h"):
    """Get latest synthesis via API."""
    try:
        response = api.get("/api/synthesis/latest", {"time_window": time_window})
        return response
    except httpx.ConnectError:
        return {
            "error": "Cannot connect to Confluence Hub API",
            "hint": "Check RAILWAY_API_URL and network connection"
        }
    except httpx.HTTPStatusError as e:
        if e.response.status_code == 401:
            return {
                "error": "Authentication failed",
                "hint": "Check AUTH_USERNAME and AUTH_PASSWORD"
            }
        return {"error": f"API error: {e.response.status_code}"}
```

### Part F: Deprecate Local Database Module

**File**: `mcp_server/database.py`

Add deprecation warning but keep for backwards compatibility:

```python
"""
DEPRECATED: Direct database access for MCP Server.

This module is deprecated as of PRD-016.
MCP tools now use API proxy pattern via api_client.py.

Kept for backwards compatibility with local development.
"""

import warnings

warnings.warn(
    "mcp_server.database is deprecated. Use mcp_server.api_client instead.",
    DeprecationWarning,
    stacklevel=2
)

# ... existing code for local fallback ...
```

---

## API Endpoint Mapping

| MCP Tool | API Endpoint | Method |
|----------|--------------|--------|
| `search_content` | `/api/search` or `/api/dashboard/search` | GET |
| `get_synthesis` | `/api/synthesis/latest` | GET |
| `get_themes` | `/api/confluence/themes` | GET |
| `get_recent` | `/api/dashboard/sources/{source}` | GET |
| `get_source_view` | `/api/sources/{source}/view` | GET |

**Note**: May need to create `/api/search` and `/api/sources/{source}/view` endpoints if they don't exist.

---

## Implementation Tasks

### Task 16.1: Create API Client Module
**Estimate**: 1 hour

**Actions**:
1. Create `mcp_server/api_client.py`
2. Implement base HTTP client with auth
3. Add error handling
4. Add retry logic for transient failures
5. Write unit tests with mocked responses

### Task 16.2: Refactor search.py Tool
**Estimate**: 30 minutes

**Actions**:
1. Replace database queries with API calls
2. Map response format to existing tool output
3. Handle errors gracefully
4. Test with real API

### Task 16.3: Refactor synthesis.py Tool
**Estimate**: 30 minutes

**Actions**:
1. Replace database queries with API calls
2. Test with real API

### Task 16.4: Refactor themes.py Tool
**Estimate**: 30 minutes

**Actions**:
1. Replace database queries with API calls
2. Test with real API

### Task 16.5: Refactor recent.py Tool
**Estimate**: 30 minutes

**Actions**:
1. Replace database queries with API calls
2. Test with real API

### Task 16.6: Refactor source_view.py Tool
**Estimate**: 1 hour

**Actions**:
1. Replace database queries with API calls
2. May need to create new API endpoint
3. Test with real API

### Task 16.7: Create Missing API Endpoints (if needed)
**Estimate**: 1-2 hours

**Actions**:
1. Create `/api/search` if not exists
2. Create `/api/sources/{source}/view` if not exists
3. Add auth to new endpoints
4. Write tests

### Task 16.8: Update Configuration & Documentation
**Estimate**: 30 minutes

**Actions**:
1. Update `mcp_server/config.py`
2. Update `mcp_server/README.md` with new config
3. Add deprecation warning to `database.py`
4. Document environment variables

### Task 16.9: End-to-End Testing with Claude Desktop
**Estimate**: 1 hour

**Actions**:
1. Update Claude Desktop config
2. Test each tool via Claude chat
3. Verify response times acceptable
4. Test error handling (disconnect Railway, wrong password)

---

## Testing Plan

### Unit Tests
- API client HTTP methods
- Error handling (timeout, 401, 500)
- Response parsing
- Retry logic

### Integration Tests
- Each tool against live Railway API
- Authentication flow
- Rate limiting behavior

### Manual Tests
- Claude Desktop asks "What are the main themes?"
- Claude Desktop searches for "gold"
- Claude Desktop gets synthesis
- Test with Railway offline (graceful error)

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| API latency affects UX | Medium | Add request timeouts; cache where appropriate |
| Auth credentials in config | Medium | Document secure storage; use env vars |
| API endpoint changes break MCP | Medium | Version API; test MCP with each backend change |
| Network dependency | Medium | Clear error messages; document offline limitations |

---

## Dependencies

- PRD-015 (Authentication) - API needs auth
- PRD-014 (Deployment) - Railway must be deployed
- `httpx` package (already in requirements.txt)

---

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `RAILWAY_API_URL` | Base URL for Railway API | Yes |
| `AUTH_USERNAME` | API authentication username | Yes |
| `AUTH_PASSWORD` | API authentication password | Yes |

---

## Files Modified/Created

**New Files**:
- `mcp_server/api_client.py`

**Modified Files**:
- `mcp_server/config.py` (remove DATABASE_PATH, add API config)
- `mcp_server/database.py` (add deprecation warning)
- `mcp_server/tools/search.py` (use API)
- `mcp_server/tools/synthesis.py` (use API)
- `mcp_server/tools/themes.py` (use API)
- `mcp_server/tools/recent.py` (use API)
- `mcp_server/tools/source_view.py` (use API)
- `mcp_server/README.md` (new configuration)

**Potentially New Backend Endpoints**:
- `backend/routes/search.py` (if needed)

---

## Sign-off

**Developer**: ___________  Date: ___________
**Sebastian**: ___________  Date: ___________

---

**Status**: Planning
