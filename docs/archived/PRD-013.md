# PRD-013: MCP Server for Claude Desktop Integration

**Version**: 1.0
**Date**: 2025-11-28
**Phase**: 5 - Simplification
**Status**: Planning

---

## Objective

Create an MCP (Model Context Protocol) server that enables Claude Desktop to query the Macro Confluence Hub database directly. This allows Sebastian to have natural conversations with Claude about his collected research.

---

## User Requirements (from Sebastian)

1. **Chat with research**: Ask Claude questions about collected content
2. **On-demand synthesis**: Request summaries on specific topics
3. **Source queries**: Find what specific sources said about topics
4. **Natural language**: No need to use dashboard UI for quick questions

---

## Success Criteria

- [ ] MCP server starts and connects to Claude Desktop
- [ ] Claude can search collected content by keyword
- [ ] Claude can retrieve latest synthesis
- [ ] Claude can query by source and date range
- [ ] Claude can list tracked themes
- [ ] Configuration documented for Sebastian
- [ ] Unit tests passing

---

## Technical Specifications

### MCP Server Overview

**Protocol**: Model Context Protocol (MCP) - Anthropic's standard for tool integration
**Transport**: stdio (local) or HTTP (remote)
**File**: `mcp_server/server.py`

### Tools Exposed to Claude

#### 1. `search_content`
Search collected research content by keyword.

**Parameters**:
```json
{
  "query": "gold positioning",
  "source": "42macro",  // optional
  "days": 7,  // optional, default 7
  "limit": 10  // optional, default 10
}
```

**Returns**:
```json
{
  "results": [
    {
      "title": "Around The Horn - Nov 28",
      "source": "42macro",
      "date": "2025-11-28",
      "snippet": "...gold positioning remains elevated...",
      "relevance": 0.95
    }
  ],
  "total_matches": 15
}
```

#### 2. `get_synthesis`
Retrieve the latest AI-generated synthesis.

**Parameters**:
```json
{
  "time_window": "24h"  // optional: "24h", "7d", "30d"
}
```

**Returns**:
```json
{
  "synthesis": "The past 24 hours of research...",
  "key_themes": ["Fed policy", "equity positioning"],
  "high_conviction_ideas": [...],
  "generated_at": "2025-11-28T18:30:00Z"
}
```

#### 3. `get_themes`
List currently tracked macro themes.

**Parameters**:
```json
{
  "active_only": true,  // optional, default true
  "min_sources": 2  // optional, themes mentioned by N+ sources
}
```

**Returns**:
```json
{
  "themes": [
    {
      "name": "Fed pivot",
      "sources": ["42macro", "Options Insight", "YouTube"],
      "first_seen": "2025-11-15",
      "conviction_trend": "rising"
    }
  ]
}
```

#### 4. `get_recent`
Get recent collections from specific sources.

**Parameters**:
```json
{
  "source": "discord",  // required
  "days": 3,  // optional, default 3
  "content_type": "video"  // optional: "video", "pdf", "text", "image"
}
```

**Returns**:
```json
{
  "items": [
    {
      "title": "Imran's Morning Update",
      "type": "video",
      "date": "2025-11-28",
      "summary": "Discussed volatility regime shift...",
      "themes": ["VIX", "volatility"]
    }
  ]
}
```

#### 5. `get_source_view`
Get a specific source's current view on a topic.

**Parameters**:
```json
{
  "source": "42macro",
  "topic": "equities"
}
```

**Returns**:
```json
{
  "source": "42macro",
  "topic": "equities",
  "current_view": "cautiously bearish",
  "last_mentioned": "2025-11-28",
  "context": "KISS model shows risk-off positioning...",
  "related_content": [...]
}
```

### Project Structure

```
mcp_server/
├── __init__.py
├── server.py          # Main MCP server
├── tools/
│   ├── __init__.py
│   ├── search.py      # search_content implementation
│   ├── synthesis.py   # get_synthesis implementation
│   ├── themes.py      # get_themes implementation
│   ├── recent.py      # get_recent implementation
│   └── source_view.py # get_source_view implementation
├── database.py        # Database connection for MCP
└── config.py          # MCP configuration
```

### Claude Desktop Configuration

**File**: `~/Library/Application Support/Claude/claude_desktop_config.json` (macOS)
**File**: `%APPDATA%\Claude\claude_desktop_config.json` (Windows)

```json
{
  "mcpServers": {
    "confluence-hub": {
      "command": "python",
      "args": [
        "C:/Users/14102/.claude-worktrees/Confluence/strange-clarke/mcp_server/server.py"
      ],
      "env": {
        "DATABASE_PATH": "C:/Users/14102/.claude-worktrees/Confluence/strange-clarke/database/confluence.db"
      }
    }
  }
}
```

---

## Implementation Tasks

### Task 13.1: Create MCP Server Structure
**Estimate**: 1 hour

**Actions**:
1. Create `mcp_server/` directory
2. Set up basic server with MCP SDK
3. Configure stdio transport
4. Test connection with Claude Desktop

### Task 13.2: Implement search_content Tool
**Estimate**: 1-2 hours

**Actions**:
1. Create `mcp_server/tools/search.py`
2. Implement full-text search with SQLite FTS
3. Add source and date filtering
4. Add relevance scoring
5. Write tests

### Task 13.3: Implement get_synthesis Tool
**Estimate**: 1 hour

**Actions**:
1. Create `mcp_server/tools/synthesis.py`
2. Query syntheses table
3. Support time window parameter
4. Write tests

### Task 13.4: Implement get_themes Tool
**Estimate**: 1 hour

**Actions**:
1. Create `mcp_server/tools/themes.py`
2. Aggregate themes from analyzed content
3. Track cross-source mentions
4. Write tests

### Task 13.5: Implement get_recent Tool
**Estimate**: 1 hour

**Actions**:
1. Create `mcp_server/tools/recent.py`
2. Query by source and content type
3. Include summaries
4. Write tests

### Task 13.6: Implement get_source_view Tool
**Estimate**: 1-2 hours

**Actions**:
1. Create `mcp_server/tools/source_view.py`
2. Extract source-specific views on topics
3. Include context and related content
4. Write tests

### Task 13.7: Documentation & Setup Guide
**Estimate**: 1 hour

**Actions**:
1. Create `mcp_server/README.md`
2. Document Claude Desktop configuration
3. Include troubleshooting guide
4. Add example queries

---

## Example Conversations (Claude Desktop)

### Example 1: Quick Research Check
**User**: "What are the main themes from my research this week?"

**Claude** (using get_synthesis + get_themes):
"Based on your collected research from the past week, the main themes are:

1. **Fed Policy Pivot** - Both 42 Macro and Options Insight are highlighting potential Fed dovishness. Darius Dale's KISS model shifted to risk-on positioning.

2. **Tech Sector Divergence** - KT Technical sees a bullish breakout pattern in QQQ, while 42 Macro remains cautious on valuations.

3. **Gold Positioning** - Multiple sources (42 Macro, Options Insight) note elevated gold positioning as a hedge..."

### Example 2: Source-Specific Query
**User**: "What has Imran been saying about volatility lately?"

**Claude** (using get_recent + search_content):
"From Options Insight Discord over the past 5 days:

- **Nov 28**: Imran discussed a potential volatility regime shift, noting VIX term structure flattening
- **Nov 26**: Morning video covered SPX skew normalization, suggested vol selling opportunities
- **Nov 25**: Highlighted unusual call buying in XLF..."

### Example 3: Trade Idea Validation
**User**: "I'm thinking about going long gold. What does my research say?"

**Claude** (using search_content + get_source_view):
"Here's what your research sources say about gold:

**42 Macro** (Nov 28): Bullish. KISS model shows favorable macro backdrop for gold. Target $2,200.

**Options Insight** (Nov 27): Neutral-to-bullish. Imran noted elevated call skew in GLD, suggesting institutional interest.

**KT Technical** (Nov 24): Bullish breakout. Price cleared key resistance at $1,950, next target $2,100.

**Confluence**: 3/3 sources lean bullish, which is relatively high alignment. Main risk flagged is potential USD strength on hawkish Fed surprise."

---

## Testing Plan

### Unit Tests
- Each tool function in isolation
- Database query correctness
- Parameter validation

### Integration Tests
- MCP server startup
- Tool invocation via MCP protocol
- End-to-end with mock Claude Desktop client

### Manual Testing
- Sebastian uses Claude Desktop with MCP server
- Tests various query types
- Validates response quality

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| MCP SDK compatibility | High | Use official Anthropic MCP SDK |
| Database locking | Medium | Use read-only connection for MCP |
| Claude Desktop version issues | Low | Document compatible versions |
| Complex queries timeout | Medium | Add query limits and pagination |

---

## Dependencies

- PRD-012 (Synthesis Agent) - for get_synthesis tool
- Claude Desktop installed
- MCP SDK (`mcp` Python package)
- SQLite FTS enabled

---

## Files Created

**New Files**:
- `mcp_server/__init__.py`
- `mcp_server/server.py`
- `mcp_server/database.py`
- `mcp_server/config.py`
- `mcp_server/tools/__init__.py`
- `mcp_server/tools/search.py`
- `mcp_server/tools/synthesis.py`
- `mcp_server/tools/themes.py`
- `mcp_server/tools/recent.py`
- `mcp_server/tools/source_view.py`
- `mcp_server/README.md`
- `tests/test_mcp/test_tools.py`

**Modified Files**:
- `requirements.txt` (add `mcp` package)

---

## Sign-off

**Developer**: ___________  Date: ___________
**Sebastian**: ___________  Date: ___________

---

**Status**: Planning (depends on PRD-012 completion)
