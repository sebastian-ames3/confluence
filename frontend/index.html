<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="AI-powered investment research synthesis and confluence analysis">
    <meta name="theme-color" content="#0F172A">
    <title>Macro Confluence Hub</title>

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Modern Design System + Layout -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/layout.css">
</head>
<body>
    <!-- Skip to main content (accessibility) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Animated Hero Background -->
    <div class="hero-background">
        <div class="gradient-layer"></div>
        <svg class="flow-lines" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path class="flow-line flow-line-1" d="M0,192 C320,280 720,100 1440,192" />
            <path class="flow-line flow-line-2" d="M0,128 C480,220 960,60 1440,160" />
            <path class="flow-line flow-line-3" d="M0,256 C240,180 720,280 1440,224" />
        </svg>
        <div class="hero-fade"></div>
    </div>

    <!-- Header (Sticky, Glassmorphic) -->
    <header class="site-header" id="site-header">
        <div class="header-container">
            <!-- Logo -->
            <a href="/" class="header-logo">
                <img src="images/brain-network.svg" alt="Macro Confluence" class="logo-icon-img">
            </a>

            <!-- Search (Desktop) -->
            <div class="header-search desktop-only">
                <button class="search-trigger" id="search-trigger">
                    <span class="search-icon">üîç</span>
                    <span class="search-placeholder">Search research...</span>
                    <kbd class="search-shortcut">‚åòK</kbd>
                </button>
            </div>

            <!-- Header Actions -->
            <div class="header-actions">
                <!-- User Menu (PRD-036) -->
                <div class="user-menu" id="user-menu" style="display: none;">
                    <span class="user-name" id="user-name"></span>
                    <button class="logout-btn" id="logout-btn" title="Sign out">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </div>

                <!-- Connection Status -->
                <div class="connection-status">
                    <span class="live-dot"></span>
                    <span class="status-text desktop-only">Live</span>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Drawer -->
    <nav class="mobile-nav" id="mobile-nav" aria-hidden="true">
        <div class="mobile-nav-overlay"></div>
        <div class="mobile-nav-panel">
            <div class="mobile-nav-header">
                <span class="logo-text">Confluence<span class="logo-accent">Hub</span></span>
                <button class="mobile-nav-close" id="mobile-nav-close">‚úï</button>
            </div>
            <ul class="mobile-nav-links">
                <li><a href="#overview" class="mobile-nav-link active" data-tab="overview">Overview</a></li>
                <li><a href="#themes" class="mobile-nav-link" data-tab="themes">Themes</a></li>
                <li><a href="#symbols" class="mobile-nav-link" data-tab="symbols">Symbols</a></li>
                <li><a href="#sources" class="mobile-nav-link" data-tab="sources">Sources</a></li>
                <li><a href="#history" class="mobile-nav-link" data-tab="history">History</a></li>
            </ul>
            <div class="mobile-nav-actions">
                <button class="fab-btn fab-btn-primary w-full" onclick="generateSynthesis('24h')">Generate Synthesis</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <div class="container">

            <!-- Hero Section -->
            <section class="hero-section" id="hero-section">
                <div class="hero-banner">
                    <img src="images/brain-network.svg" alt="Neural Network" class="hero-brain-image">
                    <h1 class="hero-title">Macro <span class="hero-title-accent">Confluence</span></h1>
                </div>
            </section>

            <!-- KPI Grid -->
            <section class="kpi-section" id="kpi-section">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Content (24h)</div>
                        <div class="kpi-value">
                            <span class="data-large" id="content-24h">-</span>
                        </div>
                        <div class="kpi-meta">items collected</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Content (7d)</div>
                        <div class="kpi-value">
                            <span class="data-large" id="content-7d">-</span>
                        </div>
                        <div class="kpi-meta">items collected</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Active Themes</div>
                        <div class="kpi-value">
                            <span class="data-large" id="kpi-themes">-</span>
                        </div>
                        <div class="kpi-meta">across sources</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Last Synthesis</div>
                        <div class="kpi-value">
                            <span class="data-large" id="last-synthesis-time">-</span>
                        </div>
                        <div class="kpi-meta" id="last-synthesis-window">-</div>
                    </div>
                </div>
            </section>

            <!-- Tab Navigation -->
            <section class="tabs-section">
                <div class="tabs-header">
                    <div class="tabs-nav" role="tablist">
                        <button class="tab-btn active" role="tab" data-tab="overview" aria-selected="true">Overview</button>
                        <button class="tab-btn" role="tab" data-tab="themes" aria-selected="false">Themes</button>
                        <button class="tab-btn" role="tab" data-tab="symbols" aria-selected="false">Symbols</button>
                        <button class="tab-btn" role="tab" data-tab="sources" aria-selected="false">Sources</button>
                        <button class="tab-btn" role="tab" data-tab="history" aria-selected="false">History</button>
                    </div>

                    <div class="tabs-filter">
                        <select class="time-filter" id="time-filter">
                            <option value="24h">Last 24 hours</option>
                            <option value="7d" selected>Last 7 days</option>
                            <option value="30d">Last 30 days</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Tab Content -->
            <section class="tab-content-area">
                <!-- Overview Tab -->
                <div class="tab-panel active" id="panel-overview" role="tabpanel">
                    <!-- Full-Width Layout -->
                    <div class="overview-content">
                        <!-- Key Takeaways (full width) -->
                        <div class="sidebar-card" id="takeaways-section">
                            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                <div class="section-title" style="margin-bottom: 0;">Key Takeaways</div>
                                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                    <span class="synthesis-meta" style="font-size: var(--text-xs); color: var(--text-muted);">
                                        <span id="synthesis-window">-</span> |
                                        <span id="synthesis-count">0</span> items
                                    </span>
                                    <div id="market-regime-badge"></div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div id="synthesis-empty" style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">
                                <div style="font-size: 32px; margin-bottom: var(--spacing-sm);">üìä</div>
                                <p style="margin: 0;">Click "Generate Synthesis" to see key takeaways.</p>
                            </div>

                            <!-- Takeaways Content -->
                            <div id="takeaways-content" style="display: none;">
                                <ol id="takeaways-list" style="margin: 0; padding-left: var(--spacing-lg); color: var(--text-secondary);"></ol>

                                <!-- Feedback Section (PRD-038) -->
                                <div id="synthesis-feedback-section" style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--text-sm); color: var(--text-muted);">Was this synthesis helpful?</span>
                                    <div id="synthesis-feedback-buttons"></div>
                                </div>

                                <button id="view-full-synthesis-btn" class="fab-btn fab-btn-ghost" style="width: 100%; margin-top: var(--spacing-md); justify-content: center;" onclick="toggleFullSynthesis()">
                                    <span class="icon">üìÑ</span>
                                    <span>View Full Synthesis</span>
                                </button>
                            </div>
                        </div>

                        <!-- Full Synthesis Panel (collapsible, hidden by default) -->
                        <div class="sidebar-card full-width-section" id="synthesis-panel" style="display: none;">
                            <div class="synthesis-panel-header">
                                <div style="display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
                                    <div class="section-title" style="margin-bottom: 0;">Full Research Synthesis</div>
                                    <div class="synthesis-meta" style="font-size: var(--text-xs); color: var(--text-muted);">
                                        <span id="synthesis-time">-</span>
                                    </div>
                                    <div class="tier-selector" id="synthesis-pill-nav">
                                        <button class="tier-btn active" data-section="synthesis-section-narrative" onclick="scrollToSynthesisSection(this)">Narrative</button>
                                        <button class="tier-btn" data-section="synthesis-section-catalysts" onclick="scrollToSynthesisSection(this)">Catalysts</button>
                                        <button class="tier-btn" data-section="synthesis-section-revisit" onclick="scrollToSynthesisSection(this)">Revisit</button>
                                    </div>
                                </div>
                                <button class="fab-btn fab-btn-ghost" style="padding: var(--spacing-xs) var(--spacing-sm); flex-shrink: 0;" onclick="toggleFullSynthesis()">
                                    <span>Collapse</span>
                                </button>
                            </div>

                            <!-- Synthesis Content -->
                            <div id="synthesis-content">
                                <!-- Section 1: Narrative -->
                                <div class="synthesis-section" id="synthesis-section-narrative">
                                    <div id="narrative-macro-context" class="narrative-macro-context"></div>
                                    <div id="narrative-paragraphs" class="narrative-paragraphs"></div>
                                    <div id="narrative-metadata" class="narrative-metadata-bar"></div>
                                </div>

                                <!-- Section 2: Catalyst Calendar -->
                                <div class="synthesis-section" id="synthesis-section-catalysts">
                                    <div class="synthesis-section-title">Catalyst Calendar</div>
                                    <div id="catalyst-timeline"></div>
                                </div>

                                <!-- Section 3: Worth Revisiting -->
                                <div class="synthesis-section" id="synthesis-section-revisit">
                                    <div class="synthesis-section-title">Worth Revisiting</div>
                                    <div id="revisit-list"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Major Source Perspectives (Full-Width, directly after Key Takeaways) -->
                        <section class="source-perspectives-section" id="stances-section" style="display: none;">
                            <div class="section-header">
                                <h2 class="section-title">Major Source Perspectives</h2>
                            </div>
                            <div class="source-perspectives-grid" id="v3-stances-list">
                                <!-- Cards populated by JavaScript -->
                            </div>
                        </section>

                        <!-- This Week's Focus (priorities) - full width -->
                        <div class="sidebar-card full-width-section" id="priorities-section" style="display: none;">
                            <div class="section-title">This Week's Focus</div>
                            <div id="v3-priorities-list"></div>
                        </div>

                        <!-- Confluence Zones - full width -->
                        <div class="sidebar-card full-width-section" id="confluence-section" style="display: none;">
                            <div class="section-title">Confluence Zones</div>
                            <div id="v3-confluence-list"></div>
                        </div>

                        <!-- Conflicts to Monitor - full width -->
                        <div class="sidebar-card full-width-section" id="conflict-section" style="display: none;">
                            <div class="section-title">Conflicts to Monitor</div>
                            <div id="v3-conflict-list"></div>
                        </div>

                    </div>
                </div>

                <!-- Symbols Tab -->
                <div class="tab-panel" id="panel-symbols" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Tracked Symbols</div>
                            <div id="symbols-list">
                                <p style="color: var(--text-muted);">Loading symbols...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Themes Tab -->
                <div class="tab-panel" id="panel-themes" role="tabpanel">
                    <!-- Themes Stats -->
                    <div class="kpi-grid" style="margin-bottom: var(--spacing-lg);">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Themes</div>
                            <div class="kpi-value"><span class="data-large" id="themes-total">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Active</div>
                            <div class="kpi-value"><span class="data-large" id="themes-active">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Emerging</div>
                            <div class="kpi-value"><span class="data-large" id="themes-emerging">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Evolved</div>
                            <div class="kpi-value"><span class="data-large" id="themes-evolved">0</span></div>
                        </div>
                    </div>

                    <!-- Themes Filters -->
                    <div class="tabs-nav" style="margin-bottom: var(--spacing-lg);">
                        <button class="tab-btn active" onclick="filterThemes('all', this)">All</button>
                        <button class="tab-btn" onclick="filterThemes('active', this)">Active</button>
                        <button class="tab-btn" onclick="filterThemes('emerging', this)">Emerging</button>
                        <button class="tab-btn" onclick="filterThemes('evolved', this)">Evolved</button>
                        <button class="tab-btn" onclick="filterThemes('dormant', this)">Dormant</button>
                    </div>

                    <!-- Themes List -->
                    <div id="themes-list" class="content-main">
                        <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                            <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìã</div>
                            <h3>No Themes Yet</h3>
                            <p style="color: var(--text-muted);">Themes will be extracted from synthesis.</p>
                        </div>
                    </div>
                </div>

                <!-- Sources Tab -->
                <div class="tab-panel" id="panel-sources" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Source Overview</div>
                            <div id="sources-detail-list">
                                <p style="color: var(--text-muted);">Loading source details...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-panel" id="panel-history" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Synthesis History</div>
                            <div id="synthesis-history-list">
                                <p style="color: var(--text-muted);">Coming soon...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Floating Action Bar -->
    <div class="floating-action-bar" id="floating-actions">
        <div class="fab-container">
            <button class="fab-btn fab-btn-warning" id="btn-analyze" onclick="analyzeContent()">
                <span class="icon">‚ö°</span>
                <span class="btn-text">Analyze</span>
            </button>
            <button class="fab-btn fab-btn-primary" id="btn-generate-24h" onclick="generateSynthesis('24h')">
                <span class="icon">üìù</span>
                <span class="btn-text">Generate 24h</span>
            </button>
            <button class="fab-btn fab-btn-secondary" id="btn-generate-7d" onclick="generateSynthesis('7d')">
                <span class="icon">üìä</span>
                <span class="btn-text">Generate 7-Day</span>
            </button>
            <button class="fab-btn fab-btn-ghost" onclick="refreshCurrentTab()">
                <span class="icon">üîÑ</span>
                <span class="btn-text desktop-only">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="search-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="search-modal-header">
                <span class="search-icon">üîç</span>
                <input type="search" class="search-modal-input" placeholder="Search themes, sources, content..." autofocus>
                <kbd class="search-modal-esc">ESC</kbd>
            </div>
            <div class="search-modal-results" id="search-results">
                <p style="color: var(--text-muted); text-align: center; padding: var(--spacing-lg);">
                    Type to search across your research...
                </p>
            </div>
        </div>
    </div>

    <!-- Login Modal (PRD-036) -->
    <div class="modal" id="login-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content login-modal-content">
            <div class="login-modal-header">
                <img src="images/brain-network.svg" alt="" class="login-logo">
                <h2 class="login-title">Macro Confluence</h2>
                <p class="login-subtitle">Sign in to continue</p>
            </div>
            <form id="login-form" class="login-form">
                <div class="input-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" class="input" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="input" required autocomplete="current-password">
                </div>
                <div id="login-error" class="login-error" style="display: none;"></div>
                <button type="submit" class="fab-btn fab-btn-primary w-full">
                    <span class="btn-text">Sign In</span>
                    <span class="btn-loading" style="display: none;">Signing in...</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Feedback Modal (PRD-038) -->
    <div class="modal" id="feedback-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Rate This Synthesis</h3>
                <button class="modal-close" onclick="FeedbackManager.closeFeedbackModal()" aria-label="Close">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="feedback-form" onsubmit="FeedbackManager.submitDetailedFeedback(event)">
                    <!-- Synthesis-specific ratings -->
                    <div id="synthesis-ratings">
                        <div class="rating-group">
                            <label>Accuracy</label>
                            <div class="star-rating" id="accuracy-rating">
                                <input type="radio" id="accuracy-5" name="accuracy_rating" value="5">
                                <label for="accuracy-5" title="Excellent"></label>
                                <input type="radio" id="accuracy-4" name="accuracy_rating" value="4">
                                <label for="accuracy-4" title="Good"></label>
                                <input type="radio" id="accuracy-3" name="accuracy_rating" value="3">
                                <label for="accuracy-3" title="Average"></label>
                                <input type="radio" id="accuracy-2" name="accuracy_rating" value="2">
                                <label for="accuracy-2" title="Poor"></label>
                                <input type="radio" id="accuracy-1" name="accuracy_rating" value="1">
                                <label for="accuracy-1" title="Very Poor"></label>
                            </div>
                        </div>
                        <div class="rating-group">
                            <label>Usefulness</label>
                            <div class="star-rating" id="usefulness-rating">
                                <input type="radio" id="usefulness-5" name="usefulness_rating" value="5">
                                <label for="usefulness-5" title="Excellent"></label>
                                <input type="radio" id="usefulness-4" name="usefulness_rating" value="4">
                                <label for="usefulness-4" title="Good"></label>
                                <input type="radio" id="usefulness-3" name="usefulness_rating" value="3">
                                <label for="usefulness-3" title="Average"></label>
                                <input type="radio" id="usefulness-2" name="usefulness_rating" value="2">
                                <label for="usefulness-2" title="Poor"></label>
                                <input type="radio" id="usefulness-1" name="usefulness_rating" value="1">
                                <label for="usefulness-1" title="Very Poor"></label>
                            </div>
                        </div>
                    </div>

                    <!-- Theme-specific rating (hidden by default) -->
                    <div id="theme-ratings" style="display: none;">
                        <div class="rating-group">
                            <label>Quality</label>
                            <div class="star-rating" id="quality-rating">
                                <input type="radio" id="quality-5" name="quality_rating" value="5">
                                <label for="quality-5" title="Excellent"></label>
                                <input type="radio" id="quality-4" name="quality_rating" value="4">
                                <label for="quality-4" title="Good"></label>
                                <input type="radio" id="quality-3" name="quality_rating" value="3">
                                <label for="quality-3" title="Average"></label>
                                <input type="radio" id="quality-2" name="quality_rating" value="2">
                                <label for="quality-2" title="Poor"></label>
                                <input type="radio" id="quality-1" name="quality_rating" value="1">
                                <label for="quality-1" title="Very Poor"></label>
                            </div>
                        </div>
                    </div>

                    <div class="rating-group" style="margin-top: var(--spacing-md);">
                        <label for="feedback-comment">Comments (optional)</label>
                        <textarea id="feedback-comment" name="comment" rows="3"
                                  class="input" placeholder="What could be improved?"
                                  maxlength="2000" style="width: 100%; resize: vertical;"></textarea>
                    </div>

                    <div class="modal-footer" style="padding: var(--spacing-md) 0 0 0; border-top: none;">
                        <button type="button" class="btn btn-secondary" onclick="FeedbackManager.closeFeedbackModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Feedback</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Symbol Detail Modal -->
    <div class="modal" id="symbol-detail-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto; position: relative;">
            <button class="modal-close" id="close-symbol-detail" aria-label="Close">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <div id="symbol-detail-content">
                <!-- Content populated by symbols.js -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Utilities & Auth (must load before other scripts) -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/health.js"></script>  <!-- PRD-045: Health monitoring widget -->
    <script src="js/quality.js"></script>  <!-- PRD-044: Synthesis quality widget -->
    <script src="js/feedback.js"></script>
    <script src="js/symbols.js"></script>

    <!-- Application JavaScript -->
    <script>
        // API_BASE is defined in js/api.js (loaded above)

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadLatestSynthesis();
            loadThemesSummary();  // Load theme count for KPI card
        });

        // Utility: Escape HTML to prevent XSS attacks
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const str = String(text);
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Utility: Safe DOM element getter with null check
        function getElement(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`Element not found: ${id}`);
            }
            return el;
        }

        // Load just the themes summary for the KPI card (lightweight)
        async function loadThemesSummary() {
            try {
                const summary = await apiFetch('/themes/summary');
                document.getElementById('kpi-themes').textContent = summary.by_status?.active || 0;
            } catch (error) {
                console.error('Error loading themes summary:', error);
                document.getElementById('kpi-themes').textContent = '0';
            }
        }

        // Initialize SymbolsManager
        let symbolsManager = null;

        // Listen for tab changes
        window.addEventListener('tabchange', (e) => {
            if (e.detail.tab === 'themes') {
                loadThemes();
            } else if (e.detail.tab === 'symbols') {
                if (!symbolsManager) {
                    symbolsManager = new SymbolsManager();
                    symbolsManager.init();
                } else {
                    symbolsManager.loadSymbols();
                }
            }
        });

        // Load status overview
        async function loadStatus() {
            try {
                const data = await apiFetch('/synthesis/status/overview');

                // Update KPI cards
                document.getElementById('content-24h').textContent = data.total_content_24h || 0;
                document.getElementById('content-7d').textContent = data.total_content_7d || 0;

                if (data.latest_synthesis) {
                    const synthTime = parseUTCDate(data.latest_synthesis.generated_at);
                    document.getElementById('last-synthesis-time').textContent = formatTimeAgo(synthTime);
                    document.getElementById('last-synthesis-window').textContent = data.latest_synthesis.time_window + ' window';
                } else {
                    document.getElementById('last-synthesis-time').textContent = 'Never';
                    document.getElementById('last-synthesis-window').textContent = '-';
                }

                // Update source status list
                const sourceList = document.getElementById('source-status-list');
                if (data.sources_status && data.sources_status.length > 0) {
                    sourceList.innerHTML = data.sources_status.map(source => `
                        <div class="source-item">
                            <div class="source-icon ${source.name.toLowerCase().replace(' ', '')}">${source.name.charAt(0)}</div>
                            <div class="source-info">
                                <div class="source-name">${source.name}</div>
                                <div class="source-count">${source.items_24h} (24h) | ${source.items_7d} (7d)</div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Load latest synthesis
        async function loadLatestSynthesis() {
            try {
                const data = await apiFetch('/synthesis/latest');

                if (data.status === 'not_found') {
                    showEmptySynthesis();
                    return;
                }

                displaySynthesis(data);

            } catch (error) {
                console.error('Error loading synthesis:', error);
                showEmptySynthesis();
            }
        }

        // Store current synthesis id for feedback (PRD-038)
        let currentSynthesisId = null;

        // Display synthesis content
        function displaySynthesis(data) {
            document.getElementById('synthesis-empty').style.display = 'none';
            document.getElementById('takeaways-content').style.display = 'block';
            document.getElementById('synthesis-content').style.display = 'block';

            // Store synthesis id for feedback (PRD-038)
            currentSynthesisId = data.id;

            // Update meta info
            document.getElementById('synthesis-window').textContent = data.time_window;
            document.getElementById('synthesis-count').textContent = data.content_count;
            document.getElementById('synthesis-time').textContent = data.generated_at ? formatDateTime(parseUTCDate(data.generated_at)) : '-';

            // Populate Key Takeaways (max 5 bullets)
            const takeawaysList = getElement('takeaways-list');
            const execSummary = data.executive_summary || {};
            const keyTakeaways = execSummary.key_takeaways || [];

            if (takeawaysList) {
                if (keyTakeaways.length > 0) {
                    takeawaysList.innerHTML = keyTakeaways.slice(0, 5).map(t =>
                        `<li style="margin-bottom: var(--spacing-xs); line-height: var(--leading-relaxed);">${escapeHtml(t)}</li>`
                    ).join('');
                } else {
                    takeawaysList.innerHTML = '<li style="color: var(--text-muted);">No key takeaways available.</li>';
                }
            }

            // Add feedback buttons (PRD-038)
            const feedbackContainer = document.getElementById('synthesis-feedback-buttons');
            if (feedbackContainer && data.id && typeof FeedbackManager !== 'undefined') {
                feedbackContainer.innerHTML = FeedbackManager.renderSynthesisFeedbackButtons(data.id);
            }

            // Update market regime badge
            let regimeValue = data.market_regime;
            if (typeof regimeValue === 'object' && regimeValue !== null) {
                regimeValue = regimeValue.current;
            }
            const regimeBadge = getElement('market-regime-badge');
            if (regimeBadge && regimeValue) {
                const regimeClass = `regime-${String(regimeValue).replace('_', '-').replace(' ', '-')}`;
                regimeBadge.innerHTML = `<span class="market-regime ${escapeHtml(regimeClass)}">${escapeHtml(regimeValue)}</span>`;
            }

            // Narrative, catalyst calendar, re-review recommendations
            displayNarrative(data.executive_summary || {}, data.content_count, data.sources_included);
            displayCatalystCalendar(data.catalyst_calendar || []);
            displayReReviewRecommendations(data.re_review_recommendations || []);

            // All detail sections
            displayV3AttentionPriorities(data.attention_priorities || []);
            displayV3ConfluenceZones(data.confluence_zones || []);
            displayV3ConflictWatch(data.conflict_watch || []);
            displayV4SourceBreakdowns(data.source_breakdowns || {}, data.content_summaries || [], true);
        }

        // PRD-041: Display V4 source breakdowns with interactive cards
        // showContentItems: false for Tier 2, true for Tier 3
        function displayV4SourceBreakdowns(breakdowns, contentSummaries, showContentItems = true) {
            const container = getElement('v3-stances-list');
            const section = getElement('stances-section');

            if (!section || !container) return;

            if (!breakdowns || Object.keys(breakdowns).length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            // Group content summaries by source for Tier 3
            const contentBySource = {};
            if (showContentItems) {
                contentSummaries.forEach(item => {
                    const key = item.channel ? `youtube:${item.channel}` : item.source;
                    if (!contentBySource[key]) contentBySource[key] = [];
                    contentBySource[key].push(item);
                });
            }

            container.innerHTML = Object.entries(breakdowns).map(([sourceName, data], index) => {
                const bias = data.overall_bias || 'neutral';
                const biasLabel = bias === 'bullish' ? 'Bullish Trend' : bias === 'bearish' ? 'Bearish' : 'Mixed Signal';
                const contentCount = data.content_count || 0;
                const sourceContent = contentBySource[sourceName] || [];
                const hasContent = sourceContent.length > 0;

                // Format display name and determine source key for styling
                const displayName = sourceName.startsWith('youtube:') ? sourceName.split(':')[1] : sourceName.replace('_', ' ');
                const sourceKey = getSourceKey(sourceName);
                const sourceIcon = getSourceIcon(sourceKey);

                // Generate sparkline path
                const sparklinePath = generateSparklinePath(bias, index);

                return `
                    <div class="source-perspective-card" data-source="${escapeHtml(sourceKey)}" onclick="toggleSourcePerspective(this)">
                        <div class="source-perspective-header">
                            <div class="source-perspective-identity">
                                <div class="source-perspective-icon">${escapeHtml(sourceIcon)}</div>
                                <span class="source-perspective-name">${escapeHtml(displayName)}</span>
                            </div>
                            <span class="source-perspective-bias ${escapeHtml(bias)}">${escapeHtml(biasLabel)}</span>
                        </div>

                        <div class="source-perspective-sparkline">
                            <svg viewBox="0 0 200 48" preserveAspectRatio="none">
                                <defs>
                                    <!-- PRD-049: Use v4 prefix to avoid ID collision with V3 sparklines -->
                                    <linearGradient id="sparkline-gradient-${index}" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color: var(--card-accent, var(--primary)); stop-opacity: 0.3"/>
                                        <stop offset="100%" style="stop-color: var(--card-accent, var(--primary)); stop-opacity: 0"/>
                                    </linearGradient>
                                </defs>
                                <path class="sparkline-area" d="${sparklinePath} L 200 48 L 0 48 Z" fill="url(#sparkline-gradient-${index})"/>
                                <path class="sparkline-path" d="${sparklinePath}"/>
                            </svg>
                        </div>

                        <div class="source-perspective-summary">${escapeHtml(data.summary)}</div>

                        <div class="source-perspective-expand">
                            <span class="source-perspective-expand-icon">‚Üì</span>
                            <span>Click to Expand</span>
                        </div>

                        <div class="source-perspective-details">
                            <div class="source-perspective-details-inner">
                                <div class="source-perspective-full-summary">${escapeHtml(data.summary)}</div>

                                ${data.key_insights && data.key_insights.length > 0 ? `
                                    <div class="source-perspective-insights">
                                        <div class="source-perspective-insights-title">Key Insights</div>
                                        <ul class="source-perspective-insights-list">
                                            ${data.key_insights.map(i => `<li>${escapeHtml(i)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${hasContent && showContentItems ? `
                                    <div class="source-perspective-content-list">
                                        <div class="source-perspective-insights-title">Content (${sourceContent.length} items)</div>
                                        ${sourceContent.slice(0, 3).map(c => `
                                            <div class="source-perspective-content-item">
                                                <div class="source-perspective-content-title">${escapeHtml(c.title || 'Untitled')}</div>
                                                ${c.summary ? `<div class="source-perspective-content-excerpt">${escapeHtml(c.summary.substring(0, 120))}${c.summary.length > 120 ? '...' : ''}</div>` : ''}
                                            </div>
                                        `).join('')}
                                        ${sourceContent.length > 3 ? `<div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--spacing-xs);">+ ${sourceContent.length - 3} more items</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get source key for CSS styling
        function getSourceKey(sourceName) {
            const name = sourceName.toLowerCase();
            if (name.includes('substack')) return 'substack';
            if (name.includes('discord')) return 'discord';
            if (name.includes('42macro') || name.includes('42 macro')) return '42macro';
            if (name.includes('youtube')) return 'youtube';
            if (name.includes('kt') || name.includes('technical')) return 'kt_technical';
            return 'substack'; // default
        }

        // Get source icon letter
        function getSourceIcon(sourceKey) {
            const icons = {
                'substack': 'S',
                'discord': 'd',
                '42macro': '4',
                'youtube': 'Y',
                'kt_technical': 'K'
            };
            return icons[sourceKey] || sourceKey.charAt(0).toUpperCase();
        }

        // Generate sparkline SVG path based on bias
        function generateSparklinePath(bias, seed) {
            const points = [];
            const numPoints = 12;

            // Create semi-random but consistent path based on seed
            for (let i = 0; i < numPoints; i++) {
                const x = (i / (numPoints - 1)) * 200;
                let baseY = 24; // middle

                // Trend based on bias
                if (bias === 'bullish') {
                    baseY = 36 - (i / numPoints) * 24; // trending up (lower Y = higher on screen)
                } else if (bias === 'bearish') {
                    baseY = 12 + (i / numPoints) * 24; // trending down
                }

                // Add some variation using seed
                const variation = Math.sin(i * 1.5 + seed) * 8;
                const y = Math.max(4, Math.min(44, baseY + variation));

                points.push(`${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`);
            }

            return points.join(' ');
        }

        // Toggle source perspective card expansion
        function toggleSourcePerspective(card) {
            // Close other expanded cards
            document.querySelectorAll('.source-perspective-card.expanded').forEach(c => {
                if (c !== card) c.classList.remove('expanded');
            });

            // Toggle this card
            card.classList.toggle('expanded');

            // Update expand text
            const expandText = card.querySelector('.source-perspective-expand span:last-child');
            if (expandText) {
                expandText.textContent = card.classList.contains('expanded') ? 'Click to Collapse' : 'Click to Expand';
            }
        }

        // Display narrative section (replaces displayV3ExecutiveSummary)
        function displayNarrative(summary, contentCount, sourcesIncluded) {
            const macroCtx = document.getElementById('narrative-macro-context');
            const paraContainer = document.getElementById('narrative-paragraphs');
            const metaBar = document.getElementById('narrative-metadata');

            if (!macroCtx || !paraContainer || !metaBar) return;

            // Macro context lead-in
            const macroContext = summary.macro_context || '';
            macroCtx.innerHTML = macroContext ? escapeHtml(macroContext) : '';

            // Split synthesis_narrative into labeled paragraphs
            const narrative = summary.synthesis_narrative || summary.narrative || '';
            const paragraphs = narrative.split('\n\n').filter(p => p.trim());
            const labels = ['Where Sources Align', 'Where They Diverge', 'What Deserves Attention'];

            if (paragraphs.length > 0) {
                paraContainer.innerHTML = paragraphs.slice(0, 3).map((p, i) => `
                    <div class="narrative-paragraph">
                        <div class="narrative-paragraph-label">${escapeHtml(labels[i] || '')}</div>
                        <div class="narrative-paragraph-text">${escapeHtml(p.trim())}</div>
                    </div>
                `).join('');
            } else {
                paraContainer.innerHTML = '<div class="narrative-paragraph-text" style="color: var(--text-muted);">No narrative available.</div>';
            }

            // Metadata bar: tone + quality grade + sources + content count
            const tone = summary.overall_tone || 'uncertain';
            const toneColor = tone === 'bullish' ? 'success' : tone === 'bearish' ? 'danger' : 'warning';

            let qualityHtml = '';
            if (typeof QualityManager !== 'undefined' && QualityManager.latestScore) {
                const grade = QualityManager.latestScore.letter_grade || '';
                if (grade) {
                    qualityHtml = `<span style="color: var(--text-secondary);">Quality: <strong>${escapeHtml(grade)}</strong></span>`;
                }
            }

            const sourceCount = Array.isArray(sourcesIncluded) ? sourcesIncluded.length : 0;
            metaBar.innerHTML = `
                <span class="badge" style="background: var(--${toneColor});">${escapeHtml(tone)}</span>
                ${qualityHtml}
                ${sourceCount > 0 ? `<span>${sourceCount} sources</span>` : ''}
                ${contentCount ? `<span>${escapeHtml(String(contentCount))} items analyzed</span>` : ''}
            `;
        }

        // Display catalyst calendar as a timeline
        function displayCatalystCalendar(catalysts) {
            const container = document.getElementById('catalyst-timeline');
            if (!container) return;

            if (!catalysts || catalysts.length === 0) {
                container.innerHTML = '<div class="catalyst-empty-state">No upcoming catalysts identified in this synthesis window.</div>';
                container.className = '';
                return;
            }

            container.className = 'catalyst-timeline';
            container.innerHTML = catalysts.map(c => {
                const impact = (c.impact || 'medium').toLowerCase();
                const impactClass = impact === 'high' ? 'impact-high' : impact === 'low' ? 'impact-low' : 'impact-medium';

                // Parse date safely (append T00:00:00 to avoid timezone shift)
                let dateLabel = c.date || 'TBD';
                if (c.date && /^\d{4}-\d{2}-\d{2}$/.test(c.date)) {
                    const d = new Date(c.date + 'T00:00:00');
                    dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                }

                // Source perspectives
                const perspectives = c.source_perspectives || c.perspectives || [];
                const perspectivesHtml = perspectives.map(p => `
                    <div class="catalyst-perspective-row">
                        <span class="catalyst-perspective-source">${escapeHtml(p.source || '')}</span>
                        <span class="catalyst-perspective-view">${escapeHtml(p.view || p.perspective || '')}</span>
                    </div>
                `).join('');

                // Related themes
                const themes = c.related_themes || c.themes || [];
                const themesHtml = themes.length > 0 ? `
                    <div class="catalyst-themes">
                        ${themes.map(t => `<span class="theme-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                ` : '';

                return `
                    <div class="catalyst-timeline-item">
                        <div class="catalyst-date-node ${impactClass}"></div>
                        <div class="catalyst-date-label">${escapeHtml(dateLabel)}</div>
                        <div class="catalyst-event-card">
                            <div class="catalyst-event-header">
                                <span class="catalyst-event-name">${escapeHtml(c.event || c.name || 'Unknown Event')}</span>
                                <span class="catalyst-impact-badge ${impactClass}">${escapeHtml(impact)}</span>
                            </div>
                            ${perspectivesHtml}
                            ${themesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Display re-review recommendations
        function displayReReviewRecommendations(recommendations) {
            const container = document.getElementById('revisit-list');
            if (!container) return;

            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="revisit-empty-state">No re-review recommendations at this time.</div>';
                return;
            }

            container.innerHTML = recommendations.map(r => {
                const trigger = r.trigger || '';
                const triggerClass = trigger ? `trigger-${trigger}` : '';
                const triggerText = trigger.replace(/_/g, ' ');

                return `
                    <div class="re-review-item">
                        <div class="re-review-header">
                            <span class="re-review-title">${escapeHtml(r.title || r.topic || 'Untitled')}</span>
                            <span class="re-review-source">${escapeHtml(r.original_source || r.source || '')}</span>
                        </div>
                        <div class="re-review-why">${escapeHtml(r.why || r.reason || '')}</div>
                        ${trigger ? `<span class="re-review-trigger ${escapeHtml(triggerClass)}">${escapeHtml(triggerText)}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Scroll to synthesis section and update active pill
        function scrollToSynthesisSection(btn) {
            const sectionId = btn.getAttribute('data-section');
            const section = document.getElementById(sectionId);
            if (!section) return;

            // Update active pill
            document.querySelectorAll('#synthesis-pill-nav .tier-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // IntersectionObserver: track which synthesis section is in view and update pill
        (function initSynthesisSectionObserver() {
            const sectionIds = ['synthesis-section-narrative', 'synthesis-section-catalysts', 'synthesis-section-revisit'];

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        document.querySelectorAll('#synthesis-pill-nav .tier-btn').forEach(b => {
                            b.classList.toggle('active', b.getAttribute('data-section') === id);
                        });
                    }
                });
            }, { threshold: 0.3 });

            // Observe after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    sectionIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) observer.observe(el);
                    });
                });
            } else {
                sectionIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) observer.observe(el);
                });
            }
        })();

        // V3: Display attention priorities
        function displayV3AttentionPriorities(priorities) {
            const container = document.getElementById('v3-priorities-list');
            const section = document.getElementById('priorities-section');

            if (!priorities || priorities.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = priorities.map(p => `
                <div style="display: flex; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm);">
                    <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-weight: var(--font-bold); flex-shrink: 0;">${p.rank || '?'}</div>
                    <div>
                        <div style="font-weight: var(--font-semibold);">${p.focus_area || 'Untitled'}</div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">${p.why || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // V3: Display confluence zones
        function displayV3ConfluenceZones(zones) {
            const container = document.getElementById('v3-confluence-list');
            const section = document.getElementById('confluence-section');

            if (!zones || zones.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = zones.map(zone => {
                const strength = zone.confluence_strength || 0;
                const aligned = zone.sources_aligned || [];
                return `
                    <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--success);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-semibold);">${zone.theme || 'Untitled'}</span>
                            <span style="font-size: var(--text-sm); color: var(--success);">${Math.round(strength * 100)}% alignment</span>
                        </div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                            ${aligned.map(s => `<div><strong>${s.source}:</strong> ${s.view}</div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // V3: Display conflict watch
        function displayV3ConflictWatch(conflicts) {
            const container = document.getElementById('v3-conflict-list');
            const section = document.getElementById('conflict-section');

            if (!conflicts || conflicts.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = conflicts.map(c => `
                <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--warning);">
                    <div style="font-weight: var(--font-semibold); margin-bottom: var(--spacing-sm);">${c.topic || 'Untitled'}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); font-size: var(--text-sm);">
                        <div style="padding: var(--spacing-sm); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md);">
                            <div style="color: var(--success); font-weight: var(--font-medium);">Bull Case</div>
                            <!-- PRD-049: Use nullish coalescing instead of || for proper undefined handling -->
                            <div style="color: var(--text-secondary);">${c.bull_case?.view ?? '-'}</div>
                        </div>
                        <div style="padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
                            <div style="color: var(--danger); font-weight: var(--font-medium);">Bear Case</div>
                            <!-- PRD-049: Use nullish coalescing instead of || for proper undefined handling -->
                            <div style="color: var(--text-secondary);">${c.bear_case?.view ?? '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show empty synthesis state
        function showEmptySynthesis() {
            // Show empty state in takeaways section
            document.getElementById('synthesis-empty').style.display = 'block';
            document.getElementById('takeaways-content').style.display = 'none';

            // Hide full synthesis panel
            document.getElementById('synthesis-panel').style.display = 'none';

            // Hide all V3 sections (they show when data is available)
            document.getElementById('priorities-section').style.display = 'none';
            document.getElementById('confluence-section').style.display = 'none';
            document.getElementById('conflict-section').style.display = 'none';
            document.getElementById('stances-section').style.display = 'none';
        }

        // Toggle full synthesis panel visibility
        function toggleFullSynthesis() {
            const panel = document.getElementById('synthesis-panel');
            const btn = document.getElementById('view-full-synthesis-btn');
            const isHidden = panel.style.display === 'none';

            panel.style.display = isHidden ? 'block' : 'none';

            if (btn) {
                btn.innerHTML = isHidden
                    ? '<span class="icon">üìÑ</span><span>Hide Full Synthesis</span>'
                    : '<span class="icon">üìÑ</span><span>View Full Synthesis</span>';
            }

            if (isHidden) {
                // Scroll to panel when opening
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Scroll back to takeaways when collapsing
                const takeaways = document.getElementById('takeaways-section');
                if (takeaways) {
                    takeaways.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Trigger collection
        async function triggerCollection(sourceName) {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="icon">‚è≥</span><span>Collecting...</span>';

            try {
                const data = await apiFetch(`/collect/trigger/${sourceName}`, {
                    method: 'POST'
                });
                btn.innerHTML = `<span class="icon">‚úì</span><span>Done (${data.saved || 0} new)</span>`;
                await loadStatus();
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                console.error('Collection error:', error);
                btn.innerHTML = '<span class="icon">‚úï</span><span>Error</span>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // Analyze content
        async function analyzeContent() {
            const btn = document.getElementById('btn-analyze');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            let totalAnalyzed = 0;
            let batchCount = 0;

            try {
                btn.innerHTML = `<span class="icon">‚ö°</span><span class="btn-text">Starting...</span>`;

                while (true) {
                    batchCount++;
                    const data = await apiFetch('/analyze/classify-batch?limit=50', {
                        method: 'POST'
                    });

                    if (data.count > 0) {
                        totalAnalyzed += data.count;
                        btn.innerHTML = `<span class="icon">‚ö°</span><span class="btn-text">Analyzed: ${totalAnalyzed}</span>`;
                        // Small delay to ensure UI updates are visible
                        await new Promise(r => setTimeout(r, 100));
                    } else {
                        break;
                    }

                    // Safety: max 20 batches to prevent infinite loop
                    if (batchCount >= 20) {
                        console.log('[Analyze] Max batches reached');
                        break;
                    }
                }

                btn.innerHTML = `<span class="icon">‚úì</span><span class="btn-text">Done (${totalAnalyzed})</span>`;
                await loadStatus();
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                console.error('Analysis error:', error);
                btn.innerHTML = `<span class="icon">‚úï</span><span class="btn-text">Error</span>`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // Generate synthesis
        async function generateSynthesis(timeWindow) {
            const btn = timeWindow === '24h' ? document.getElementById('btn-generate-24h') : document.getElementById('btn-generate-7d');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;

            // Start elapsed time counter
            let seconds = 0;
            const timerInterval = setInterval(() => {
                seconds++;
                btn.innerHTML = `<span class="icon">‚è≥</span><span class="btn-text">Generating... ${seconds}s</span>`;
            }, 1000);

            try {
                btn.innerHTML = `<span class="icon">‚è≥</span><span class="btn-text">Generating... 0s</span>`;

                const data = await apiFetch('/synthesis/generate', {
                    method: 'POST',
                    body: JSON.stringify({ time_window: timeWindow })
                });

                clearInterval(timerInterval);

                if (data.status === 'success') {
                    await loadLatestSynthesis();
                    await loadStatus();
                    btn.innerHTML = `<span class="icon">‚úì</span><span class="btn-text">Done (${seconds}s)</span>`;
                } else if (data.status === 'no_content') {
                    alert(data.message || 'No content available');
                    btn.innerHTML = originalHTML;
                } else {
                    throw new Error(data.detail || 'Failed');
                }
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                clearInterval(timerInterval);
                console.error('Generation error:', error);
                btn.innerHTML = `<span class="icon">‚úï</span><span class="btn-text">Error</span>`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // =====================================================
        // THEMES TAB
        // =====================================================
        let allThemes = [];
        let currentThemeFilter = 'all';

        async function loadThemes() {
            try {
                const summary = await apiFetch('/themes/summary');

                document.getElementById('themes-total').textContent = summary.total || 0;
                document.getElementById('themes-active').textContent = summary.by_status?.active || 0;
                document.getElementById('themes-emerging').textContent = summary.by_status?.emerging || 0;
                document.getElementById('themes-evolved').textContent = summary.by_status?.evolved || 0;
                document.getElementById('kpi-themes').textContent = summary.by_status?.active || 0;

                const themesData = await apiFetch('/themes');
                allThemes = themesData.themes || [];
                displayThemes(allThemes);

            } catch (error) {
                console.error('Error loading themes:', error);
            }
        }

        function filterThemes(status, btnEl) {
            currentThemeFilter = status;
            document.querySelectorAll('#panel-themes .tabs-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');

            let filtered = status === 'all' ? allThemes : allThemes.filter(t => t.status === status);
            displayThemes(filtered);
        }

        function displayThemes(themes) {
            const container = document.getElementById('themes-list');
            if (!themes || themes.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìã</div>
                        <h3>No Themes Found</h3>
                        <p style="color: var(--text-muted);">${currentThemeFilter === 'all' ? 'Themes will be extracted from synthesis.' : `No ${currentThemeFilter} themes.`}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = themes.map(theme => {
                const statusColor = theme.status === 'active' ? 'success' : theme.status === 'emerging' ? 'warning' : theme.status === 'evolved' ? 'primary' : 'text-muted';
                // Generate feedback buttons if FeedbackManager is available (PRD-038)
                const feedbackButtons = (typeof FeedbackManager !== 'undefined' && theme.id)
                    ? FeedbackManager.renderThemeFeedbackButtons(theme.id)
                    : '';
                return `
                    <div class="sidebar-card" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-semibold);">${theme.name}</span>
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                ${feedbackButtons}
                                <span class="badge" style="background: var(--${statusColor}); color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px;">${theme.status}</span>
                            </div>
                        </div>
                        ${theme.description ? `<p style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-sm);">${theme.description}</p>` : ''}
                        <div style="font-size: var(--text-xs); color: var(--text-muted);">
                            Evidence: ${theme.evidence_count || 0} items
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================
        // SOURCES TAB
        // =====================================================
        let sourcesLoaded = false;
        let currentSourceView = 'list'; // 'list' or 'detail'
        let currentSourceName = null;

        async function loadSources() {
            if (sourcesLoaded && currentSourceView === 'list') return;

            const container = document.getElementById('sources-detail-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading sources...</p>';

            try {
                const sources = await apiFetch('/dashboard/sources');
                displaySources(sources);
                sourcesLoaded = true;
                currentSourceView = 'list';
            } catch (error) {
                console.error('Error loading sources:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading Sources</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                    </div>
                `;
            }
        }

        function displaySources(sources) {
            const container = document.getElementById('sources-detail-list');

            if (!sources || sources.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üì°</div>
                        <h3>No Sources Found</h3>
                        <p style="color: var(--text-muted);">No data sources have been configured.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md);">
                    ${sources.map(source => {
                        const lastCollected = source.last_collected ? formatTimeAgo(parseUTCDate(source.last_collected)) : 'Never';
                        const statusColor = source.active ? 'var(--success)' : 'var(--text-muted)';
                        const statusText = source.active ? 'Active' : 'Inactive';

                        return `
                            <div class="sidebar-card source-card" onclick="loadSourceDetail('${source.name}')" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                                    <span style="font-weight: var(--font-semibold); font-size: var(--text-lg);">${source.name}</span>
                                    <span style="display: flex; align-items: center; gap: 4px; font-size: var(--text-xs);">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></span>
                                        ${statusText}
                                    </span>
                                </div>
                                <div style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                                    Type: ${source.type}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); font-size: var(--text-sm);">
                                    <div>
                                        <div style="color: var(--text-muted);">Total Items</div>
                                        <div style="font-weight: var(--font-semibold);">${source.total_items || 0}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">Analyzed</div>
                                        <div style="font-weight: var(--font-semibold);">${source.analyzed_items || 0}</div>
                                    </div>
                                </div>
                                <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-sm); border-top: 1px solid var(--border-subtle); font-size: var(--text-xs); color: var(--text-muted);">
                                    Last collected: ${lastCollected}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function loadSourceDetail(sourceName) {
            currentSourceName = sourceName;
            currentSourceView = 'detail';

            const container = document.getElementById('sources-detail-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading content...</p>';

            try {
                const content = await apiFetch(`/dashboard/sources/${sourceName}?limit=20`);
                displaySourceDetail(sourceName, content);
            } catch (error) {
                console.error('Error loading source detail:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading Content</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadSources()" style="margin-top: var(--spacing-md);">‚Üê Back to Sources</button>
                    </div>
                `;
            }
        }

        function displaySourceDetail(sourceName, content) {
            const container = document.getElementById('sources-detail-list');

            const backButton = `
                <button class="btn btn-secondary" onclick="sourcesLoaded = false; loadSources();" style="margin-bottom: var(--spacing-md);">
                    ‚Üê Back to Sources
                </button>
            `;

            if (!content || content.length === 0) {
                container.innerHTML = `
                    ${backButton}
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üì≠</div>
                        <h3>No Content</h3>
                        <p style="color: var(--text-muted);">No content has been collected from ${sourceName} yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                ${backButton}
                <h3 style="margin-bottom: var(--spacing-md);">${sourceName} - Recent Content (${content.length} items)</h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    ${content.map(item => {
                        const collectedAt = item.collected_at ? formatTimeAgo(parseUTCDate(item.collected_at)) : '-';
                        const sentiment = item.sentiment || 'neutral';
                        const sentimentColor = sentiment === 'bullish' ? 'var(--success)' : sentiment === 'bearish' ? 'var(--danger)' : 'var(--text-muted)';

                        return `
                            <div class="sidebar-card" style="padding: var(--spacing-sm) var(--spacing-md);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--spacing-md);">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: var(--font-medium); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${item.title || 'Untitled'}
                                        </div>
                                        ${item.summary ? `<div style="font-size: var(--text-sm); color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${item.summary}</div>` : ''}
                                    </div>
                                    <div style="flex-shrink: 0; text-align: right; font-size: var(--text-xs);">
                                        <div style="color: var(--text-muted);">${collectedAt}</div>
                                        <div style="color: ${sentimentColor}; text-transform: capitalize;">${sentiment}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // =====================================================
        // HISTORY TAB
        // =====================================================
        let historyLoaded = false;
        let currentHistoryView = 'list'; // 'list' or 'detail'
        let historyOffset = 0;
        const historyLimit = 10;

        async function loadHistory(offset = 0) {
            if (historyLoaded && currentHistoryView === 'list' && offset === historyOffset) return;

            historyOffset = offset;
            const container = document.getElementById('synthesis-history-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading history...</p>';

            try {
                const data = await apiFetch(`/synthesis/history?limit=${historyLimit}&offset=${offset}`);
                displayHistory(data);
                historyLoaded = true;
                currentHistoryView = 'list';
            } catch (error) {
                console.error('Error loading history:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading History</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                    </div>
                `;
            }
        }

        function displayHistory(data) {
            const container = document.getElementById('synthesis-history-list');
            const { syntheses, total, limit, offset } = data;

            if (!syntheses || syntheses.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìú</div>
                        <h3>No Synthesis History</h3>
                        <p style="color: var(--text-muted);">Generate a synthesis to see it here.</p>
                    </div>
                `;
                return;
            }

            const pagination = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <span style="font-size: var(--text-sm); color: var(--text-muted);">
                        Showing ${offset + 1}-${Math.min(offset + syntheses.length, total)} of ${total}
                    </span>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn btn-secondary btn-sm" onclick="loadHistory(${Math.max(0, offset - limit)})" ${offset === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="loadHistory(${offset + limit})" ${offset + limit >= total ? 'disabled' : ''}>
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = `
                ${pagination}
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    ${syntheses.map(synth => {
                        const generatedAt = synth.generated_at ? formatDateTime(parseUTCDate(synth.generated_at)) : '-';
                        const regimeColor = synth.market_regime === 'risk-on' ? 'var(--success)' :
                                           synth.market_regime === 'risk-off' ? 'var(--danger)' : 'var(--warning)';
                        const themes = synth.key_themes || [];

                        return `
                            <div class="sidebar-card" onclick="loadSynthesisDetail(${synth.id})" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm);">
                                    <div>
                                        <div style="font-weight: var(--font-semibold);">${generatedAt}</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-muted);">
                                            ${synth.time_window} window ‚Ä¢ ${synth.content_count || 0} items
                                        </div>
                                    </div>
                                    <span style="background: ${regimeColor}; color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px; text-transform: capitalize;">
                                        ${synth.market_regime || 'unknown'}
                                    </span>
                                </div>
                                ${synth.synthesis_preview ? `
                                    <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-sm); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                        ${synth.synthesis_preview}
                                    </p>
                                ` : ''}
                                ${themes.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                        ${themes.slice(0, 4).map(t => `
                                            <span style="background: var(--bg-elevated); padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px; color: var(--text-secondary);">
                                                ${typeof t === 'string' ? t : t.theme || t.name || 'Theme'}
                                            </span>
                                        `).join('')}
                                        ${themes.length > 4 ? `<span style="font-size: 10px; color: var(--text-muted);">+${themes.length - 4} more</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                ${pagination}
            `;
        }

        async function loadSynthesisDetail(synthesisId) {
            currentHistoryView = 'detail';

            const container = document.getElementById('synthesis-history-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading synthesis...</p>';

            try {
                const synthesis = await apiFetch(`/synthesis/${synthesisId}`);
                displaySynthesisDetail(synthesis);
            } catch (error) {
                console.error('Error loading synthesis:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading Synthesis</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                        <button class="btn btn-secondary" onclick="historyLoaded = false; loadHistory();" style="margin-top: var(--spacing-md);">‚Üê Back to History</button>
                    </div>
                `;
            }
        }

        function displaySynthesisDetail(synth) {
            const container = document.getElementById('synthesis-history-list');
            const generatedAt = synth.generated_at ? formatDateTime(parseUTCDate(synth.generated_at)) : '-';

            const backButton = `
                <button class="btn btn-secondary" onclick="historyLoaded = false; loadHistory();" style="margin-bottom: var(--spacing-md);">
                    ‚Üê Back to History
                </button>
            `;

            const themes = synth.key_themes || [];
            const ideas = synth.high_conviction_ideas || [];
            const contradictions = synth.contradictions || [];
            const catalysts = synth.catalysts || [];

            container.innerHTML = `
                ${backButton}
                <div class="sidebar-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                        <div>
                            <h3 style="margin: 0;">Synthesis #${synth.id}</h3>
                            <div style="font-size: var(--text-sm); color: var(--text-muted);">${generatedAt}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: var(--text-sm);">${synth.time_window} window</div>
                            <div style="font-size: var(--text-xs); color: var(--text-muted);">${synth.content_count || 0} items analyzed</div>
                        </div>
                    </div>

                    ${synth.market_regime ? `
                        <div style="margin-bottom: var(--spacing-md);">
                            <span style="font-size: var(--text-sm); color: var(--text-muted);">Market Regime:</span>
                            <span style="font-weight: var(--font-semibold); text-transform: capitalize;"> ${synth.market_regime}</span>
                        </div>
                    ` : ''}

                    ${synth.synthesis ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Summary</h4>
                            <p style="font-size: var(--text-sm); color: var(--text-secondary); white-space: pre-wrap;">${synth.synthesis}</p>
                        </div>
                    ` : ''}

                    ${themes.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Key Themes (${themes.length})</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                                ${themes.map(t => `
                                    <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: var(--text-sm);">
                                        ${typeof t === 'string' ? t : t.theme || t.name || 'Theme'}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${ideas.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">High Conviction Ideas (${ideas.length})</h4>
                            <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                                ${ideas.map(idea => `<li style="margin-bottom: 4px;">${typeof idea === 'string' ? idea : idea.idea || idea.description || JSON.stringify(idea)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${contradictions.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Contradictions (${contradictions.length})</h4>
                            <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                                ${contradictions.map(c => `<li style="margin-bottom: 4px;">${typeof c === 'string' ? c : c.description || c.conflict || JSON.stringify(c)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${catalysts.length > 0 ? `
                        <div>
                            <h4 style="margin-bottom: var(--spacing-sm);">Catalysts (${catalysts.length})</h4>
                            <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                                ${catalysts.map(c => `<li style="margin-bottom: 4px;">${typeof c === 'string' ? c : c.event || c.description || JSON.stringify(c)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // =====================================================
        // UTILITIES
        // =====================================================
        function parseUTCDate(isoString) {
            if (!isoString) return null;
            if (!isoString.endsWith('Z') && !isoString.includes('+') && !isoString.includes('-', 10)) {
                isoString = isoString + 'Z';
            }
            return new Date(isoString);
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function formatDateTime(date) {
            if (!date) return '-';
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // =====================================================
        // REFRESH CURRENT TAB
        // =====================================================
        async function refreshCurrentTab() {
            // Find active tab
            const activeTab = document.querySelector('.tab-btn.active');
            const tabName = activeTab ? activeTab.dataset.tab : 'overview';

            console.log('[Refresh] Refreshing tab:', tabName);

            // Force refresh by resetting loaded flags
            switch (tabName) {
                case 'overview':
                    await Promise.all([loadStatus(), loadLatestSynthesis()]);
                    break;
                case 'themes':
                    await loadThemes();
                    break;
                case 'symbols':
                    if (symbolsManager) {
                        await symbolsManager.loadSymbols();
                    }
                    break;
                case 'sources':
                    sourcesLoaded = false;
                    await loadSources();
                    break;
                case 'history':
                    historyLoaded = false;
                    await loadHistory();
                    break;
            }
        }

        // =====================================================
        // TAB CHANGE EVENT HANDLER
        // =====================================================
        window.addEventListener('tabchange', (e) => {
            const tab = e.detail.tab;
            console.log('[Tab] Switched to:', tab);

            if (tab === 'themes') {
                loadThemes();
            } else if (tab === 'symbols') {
                if (!symbolsManager) {
                    symbolsManager = new SymbolsManager();
                    symbolsManager.init();
                } else {
                    symbolsManager.loadSymbols();
                }
            } else if (tab === 'sources') {
                loadSources();
            } else if (tab === 'history') {
                loadHistory();
            }
        });

        // Handle initial page load with hash
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.slice(1);
            if (hash === 'sources') {
                loadSources();
            } else if (hash === 'history') {
                loadHistory();
            } else if (hash === 'themes') {
                loadThemes();
            } else if (hash === 'symbols') {
                if (!symbolsManager) {
                    symbolsManager = new SymbolsManager();
                    symbolsManager.init();
                }
            }
        });
    </script>

    <!-- Navigation & UI Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/accessibility.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/toast.js"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4" crossorigin="anonymous"></script>

    <!-- Chart Component Scripts -->
    <script src="js/charts/chartConfig.js"></script>
    <script src="js/charts/confluenceRadar.js"></script>
    <script src="js/charts/themeTimeline.js"></script>
    <script src="js/charts/index.js"></script>
</body>
</html>
