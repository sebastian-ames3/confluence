<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="AI-powered investment research synthesis and confluence analysis">
    <meta name="theme-color" content="#0F172A">
    <title>Macro Confluence Hub</title>

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Modern Design System + Layout -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/layout.css">
</head>
<body>
    <!-- Skip to main content (accessibility) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Animated Hero Background -->
    <div class="hero-background">
        <div class="gradient-layer"></div>
        <svg class="flow-lines" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path class="flow-line flow-line-1" d="M0,192 C320,280 720,100 1440,192" />
            <path class="flow-line flow-line-2" d="M0,128 C480,220 960,60 1440,160" />
            <path class="flow-line flow-line-3" d="M0,256 C240,180 720,280 1440,224" />
        </svg>
        <div class="hero-fade"></div>
    </div>

    <!-- Header (Sticky, Glassmorphic) -->
    <header class="site-header" id="site-header">
        <div class="header-container">
            <!-- Logo -->
            <a href="/" class="header-logo">
                <span class="logo-icon">üìä</span>
                <span class="logo-text">Confluence<span class="logo-accent">Hub</span></span>
            </a>

            <!-- Search (Desktop) -->
            <div class="header-search desktop-only">
                <button class="search-trigger" id="search-trigger">
                    <span class="search-icon">üîç</span>
                    <span class="search-placeholder">Search research...</span>
                    <kbd class="search-shortcut">‚åòK</kbd>
                </button>
            </div>

            <!-- Header Actions -->
            <div class="header-actions">
                <!-- Connection Status -->
                <div class="connection-status">
                    <span class="live-dot"></span>
                    <span class="status-text desktop-only">Live</span>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Drawer -->
    <nav class="mobile-nav" id="mobile-nav" aria-hidden="true">
        <div class="mobile-nav-overlay"></div>
        <div class="mobile-nav-panel">
            <div class="mobile-nav-header">
                <span class="logo-text">Confluence<span class="logo-accent">Hub</span></span>
                <button class="mobile-nav-close" id="mobile-nav-close">‚úï</button>
            </div>
            <ul class="mobile-nav-links">
                <li><a href="#overview" class="mobile-nav-link active" data-tab="overview">Overview</a></li>
                <li><a href="#themes" class="mobile-nav-link" data-tab="themes">Themes</a></li>
                <li><a href="#sources" class="mobile-nav-link" data-tab="sources">Sources</a></li>
                <li><a href="#history" class="mobile-nav-link" data-tab="history">History</a></li>
            </ul>
            <div class="mobile-nav-actions">
                <button class="fab-btn fab-btn-primary w-full" onclick="generateSynthesis('24h')">Generate Synthesis</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <div class="container">

            <!-- Hero Section -->
            <section class="hero-section" id="hero-section">
                <div class="hero-banner">
                    <img src="images/brain-network.svg" alt="Neural Network" class="hero-brain-image">
                    <h1 class="hero-title">Macro <span class="hero-title-accent">Confluence</span></h1>
                </div>
            </section>

            <!-- KPI Grid -->
            <section class="kpi-section" id="kpi-section">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Content (24h)</div>
                        <div class="kpi-value">
                            <span class="data-large" id="content-24h">-</span>
                        </div>
                        <div class="kpi-meta">items collected</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Content (7d)</div>
                        <div class="kpi-value">
                            <span class="data-large" id="content-7d">-</span>
                        </div>
                        <div class="kpi-meta">items collected</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Active Themes</div>
                        <div class="kpi-value">
                            <span class="data-large" id="kpi-themes">-</span>
                        </div>
                        <div class="kpi-meta">across sources</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Last Synthesis</div>
                        <div class="kpi-value">
                            <span class="data-large" id="last-synthesis-time">-</span>
                        </div>
                        <div class="kpi-meta" id="last-synthesis-window">-</div>
                    </div>
                </div>
            </section>

            <!-- Tab Navigation -->
            <section class="tabs-section">
                <div class="tabs-header">
                    <div class="tabs-nav" role="tablist">
                        <button class="tab-btn active" role="tab" data-tab="overview" aria-selected="true">Overview</button>
                        <button class="tab-btn" role="tab" data-tab="themes" aria-selected="false">Themes</button>
                        <button class="tab-btn" role="tab" data-tab="sources" aria-selected="false">Sources</button>
                        <button class="tab-btn" role="tab" data-tab="history" aria-selected="false">History</button>
                    </div>

                    <div class="tabs-filter">
                        <select class="time-filter" id="time-filter">
                            <option value="24h">Last 24 hours</option>
                            <option value="7d" selected>Last 7 days</option>
                            <option value="30d">Last 30 days</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Tab Content -->
            <section class="tab-content-area">
                <!-- Overview Tab -->
                <div class="tab-panel active" id="panel-overview" role="tabpanel">
                    <div class="content-grid">
                        <!-- Main Column -->
                        <div class="content-main">
                            <!-- 1. FIRST: Market Visualization Charts (above the fold) -->
                            <div class="sidebar-card charts-section">
                                <div class="section-title">Market Visualization</div>
                                <div class="charts-grid">
                                    <div class="chart-container chart-container-md" data-chart="sentiment-gauge" data-chart-type="sentiment-gauge">
                                        <div class="chart-header"><span class="chart-title">Sentiment</span></div>
                                        <div class="chart-canvas-wrapper">
                                            <div class="chart-skeleton" id="skeleton-sentiment-gauge"></div>
                                            <canvas id="sentiment-gauge-canvas" style="display: none;"></canvas>
                                        </div>
                                    </div>
                                    <div class="chart-container chart-container-md" data-chart="source-donut" data-chart-type="source-donut">
                                        <div class="chart-header"><span class="chart-title">Sources</span></div>
                                        <div class="chart-canvas-wrapper">
                                            <div class="chart-skeleton" id="skeleton-source-donut"></div>
                                            <canvas id="source-donut-canvas" style="display: none;"></canvas>
                                        </div>
                                    </div>
                                    <div class="chart-container chart-container-md" data-chart="conviction-bar" data-chart-type="conviction-bar">
                                        <div class="chart-header"><span class="chart-title">Conviction</span></div>
                                        <div class="chart-canvas-wrapper">
                                            <div class="chart-skeleton" id="skeleton-conviction-bar"></div>
                                            <canvas id="conviction-bar-canvas" style="display: none;"></canvas>
                                        </div>
                                    </div>
                                    <div class="chart-container chart-container-heatmap" data-chart="confluence-heatmap" data-chart-type="confluence-heatmap" id="confluence-heatmap">
                                        <div class="chart-header"><span class="chart-title">Confluence</span></div>
                                        <div class="chart-canvas-wrapper">
                                            <div class="chart-skeleton" id="skeleton-confluence-heatmap"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. SECOND: Key Takeaways (compact, extracted from synthesis) -->
                            <div class="sidebar-card" id="takeaways-section">
                                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                    <div class="section-title" style="margin-bottom: 0;">Key Takeaways</div>
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <span class="synthesis-meta" style="font-size: var(--text-xs); color: var(--text-muted);">
                                            <span id="synthesis-window">-</span> |
                                            <span id="synthesis-count">0</span> items
                                        </span>
                                        <div id="market-regime-badge"></div>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div id="synthesis-empty" style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">
                                    <div style="font-size: 32px; margin-bottom: var(--spacing-sm);">üìä</div>
                                    <p style="margin: 0;">Click "Generate Synthesis" to see key takeaways.</p>
                                </div>

                                <!-- Takeaways Content -->
                                <div id="takeaways-content" style="display: none;">
                                    <ol id="takeaways-list" style="margin: 0; padding-left: var(--spacing-lg); color: var(--text-secondary);"></ol>
                                    <button id="view-full-synthesis-btn" class="fab-btn fab-btn-ghost" style="width: 100%; margin-top: var(--spacing-md); justify-content: center;" onclick="toggleFullSynthesis()">
                                        <span class="icon">üìÑ</span>
                                        <span>View Full Synthesis</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 3. THIRD: This Week's Focus (priorities) -->
                            <div class="sidebar-card" id="priorities-section" style="display: none;">
                                <div class="section-title">This Week's Focus</div>
                                <div id="v3-priorities-list"></div>
                            </div>

                            <!-- 4. FOURTH: Confluence Zones -->
                            <div class="sidebar-card" id="confluence-section" style="display: none;">
                                <div class="section-title">Confluence Zones</div>
                                <div id="v3-confluence-list"></div>
                            </div>

                            <!-- 5. LAST: Conflicts to Monitor -->
                            <div class="sidebar-card" id="conflict-section" style="display: none;">
                                <div class="section-title">Conflicts to Monitor</div>
                                <div id="v3-conflict-list"></div>
                            </div>

                            <!-- Full Synthesis Panel (collapsible, hidden by default) -->
                            <div class="sidebar-card" id="synthesis-panel" style="display: none;">
                                <div class="synthesis-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-subtle);">
                                    <div>
                                        <div class="section-title" style="margin-bottom: var(--spacing-xs);">Full Research Synthesis</div>
                                        <div class="synthesis-meta" style="font-size: var(--text-sm); color: var(--text-muted);">
                                            <span id="synthesis-time">-</span>
                                        </div>
                                    </div>
                                    <button class="fab-btn fab-btn-ghost" style="padding: var(--spacing-xs) var(--spacing-sm);" onclick="toggleFullSynthesis()">
                                        <span>Collapse</span>
                                    </button>
                                </div>

                                <!-- Synthesis Content -->
                                <div id="synthesis-content">
                                    <div class="synthesis-text" id="synthesis-text"></div>
                                    <div class="theme-tags" id="theme-tags" style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin-top: var(--spacing-md);"></div>

                                    <!-- V3 Content -->
                                    <div id="v3-content" style="display: none;">
                                        <div id="v3-executive-section" class="v3-executive-summary"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <aside class="content-sidebar">
                            <!-- Source Status -->
                            <div class="sidebar-card">
                                <div class="sidebar-title">Source Status</div>
                                <div id="source-status-list" class="source-list">
                                    <div style="color: var(--text-muted);">Loading...</div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="sidebar-card">
                                <div class="sidebar-title">Quick Actions</div>
                                <div class="quick-actions" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                    <button class="fab-btn fab-btn-secondary w-full" onclick="triggerCollection('youtube')">
                                        <span class="icon">‚ñ∂Ô∏è</span>
                                        <span>Collect YouTube</span>
                                    </button>
                                    <button class="fab-btn fab-btn-secondary w-full" onclick="triggerCollection('substack')">
                                        <span class="icon">üì∞</span>
                                        <span>Collect Substack</span>
                                    </button>
                                    <button class="fab-btn fab-btn-secondary w-full" onclick="triggerCollection('kt_technical')">
                                        <span class="icon">üìà</span>
                                        <span>Collect KT Technical</span>
                                    </button>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); text-align: center; margin-top: var(--spacing-sm);">
                                        Discord & 42 Macro run locally
                                    </div>
                                </div>
                            </div>

                            <!-- Source Stances (scrollable) -->
                            <div class="sidebar-card" id="stances-section" style="display: none;">
                                <div class="sidebar-title">Source Perspectives</div>
                                <div id="v3-stances-list" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </aside>
                    </div>
                </div>

                <!-- Themes Tab -->
                <div class="tab-panel" id="panel-themes" role="tabpanel">
                    <!-- Themes Stats -->
                    <div class="kpi-grid" style="margin-bottom: var(--spacing-lg);">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Themes</div>
                            <div class="kpi-value"><span class="data-large" id="themes-total">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Active</div>
                            <div class="kpi-value"><span class="data-large" id="themes-active">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Emerging</div>
                            <div class="kpi-value"><span class="data-large" id="themes-emerging">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Evolved</div>
                            <div class="kpi-value"><span class="data-large" id="themes-evolved">0</span></div>
                        </div>
                    </div>

                    <!-- Themes Filters -->
                    <div class="tabs-nav" style="margin-bottom: var(--spacing-lg);">
                        <button class="tab-btn active" onclick="filterThemes('all', this)">All</button>
                        <button class="tab-btn" onclick="filterThemes('active', this)">Active</button>
                        <button class="tab-btn" onclick="filterThemes('emerging', this)">Emerging</button>
                        <button class="tab-btn" onclick="filterThemes('evolved', this)">Evolved</button>
                        <button class="tab-btn" onclick="filterThemes('dormant', this)">Dormant</button>
                    </div>

                    <!-- Themes List -->
                    <div id="themes-list" class="content-main">
                        <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                            <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìã</div>
                            <h3>No Themes Yet</h3>
                            <p style="color: var(--text-muted);">Themes will be extracted from synthesis.</p>
                        </div>
                    </div>
                </div>

                <!-- Sources Tab -->
                <div class="tab-panel" id="panel-sources" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Source Overview</div>
                            <div id="sources-detail-list">
                                <p style="color: var(--text-muted);">Loading source details...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-panel" id="panel-history" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Synthesis History</div>
                            <div id="synthesis-history-list">
                                <p style="color: var(--text-muted);">Coming soon...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Floating Action Bar -->
    <div class="floating-action-bar" id="floating-actions">
        <div class="fab-container">
            <button class="fab-btn fab-btn-warning" id="btn-analyze" onclick="analyzeContent()">
                <span class="icon">‚ö°</span>
                <span class="btn-text">Analyze</span>
            </button>
            <button class="fab-btn fab-btn-primary" id="btn-generate-24h" onclick="generateSynthesis('24h')">
                <span class="icon">üìù</span>
                <span class="btn-text">Generate 24h</span>
            </button>
            <button class="fab-btn fab-btn-secondary" id="btn-generate-7d" onclick="generateSynthesis('7d')">
                <span class="icon">üìä</span>
                <span class="btn-text">Generate 7-Day</span>
            </button>
            <button class="fab-btn fab-btn-ghost" onclick="refreshCurrentTab()">
                <span class="icon">üîÑ</span>
                <span class="btn-text desktop-only">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="search-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="search-modal-header">
                <span class="search-icon">üîç</span>
                <input type="search" class="search-modal-input" placeholder="Search themes, sources, content..." autofocus>
                <kbd class="search-modal-esc">ESC</kbd>
            </div>
            <div class="search-modal-results" id="search-results">
                <p style="color: var(--text-muted); text-align: center; padding: var(--spacing-lg);">
                    Type to search across your research...
                </p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Application JavaScript -->
    <script>
        // API Base URL
        const API_BASE = '/api';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadLatestSynthesis();
            loadThemesSummary();  // Load theme count for KPI card
        });

        // Load just the themes summary for the KPI card (lightweight)
        async function loadThemesSummary() {
            try {
                const response = await fetch(`${API_BASE}/themes/summary`);
                const summary = await response.json();
                document.getElementById('kpi-themes').textContent = summary.by_status?.active || 0;
            } catch (error) {
                console.error('Error loading themes summary:', error);
                document.getElementById('kpi-themes').textContent = '0';
            }
        }

        // Listen for tab changes
        window.addEventListener('tabchange', (e) => {
            if (e.detail.tab === 'themes') {
                loadThemes();
            }
        });

        // Load status overview
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/synthesis/status/overview`);
                const data = await response.json();

                // Update KPI cards
                document.getElementById('content-24h').textContent = data.total_content_24h || 0;
                document.getElementById('content-7d').textContent = data.total_content_7d || 0;

                if (data.latest_synthesis) {
                    const synthTime = parseUTCDate(data.latest_synthesis.generated_at);
                    document.getElementById('last-synthesis-time').textContent = formatTimeAgo(synthTime);
                    document.getElementById('last-synthesis-window').textContent = data.latest_synthesis.time_window + ' window';
                } else {
                    document.getElementById('last-synthesis-time').textContent = 'Never';
                    document.getElementById('last-synthesis-window').textContent = '-';
                }

                // Update source status list
                const sourceList = document.getElementById('source-status-list');
                if (data.sources_status && data.sources_status.length > 0) {
                    sourceList.innerHTML = data.sources_status.map(source => `
                        <div class="source-item">
                            <div class="source-icon ${source.name.toLowerCase().replace(' ', '')}">${source.name.charAt(0)}</div>
                            <div class="source-info">
                                <div class="source-name">${source.name}</div>
                                <div class="source-count">${source.items_24h} (24h) | ${source.items_7d} (7d)</div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Load latest synthesis
        async function loadLatestSynthesis() {
            try {
                const response = await fetch(`${API_BASE}/synthesis/latest`);
                const data = await response.json();

                if (data.status === 'not_found') {
                    showEmptySynthesis();
                    return;
                }

                displaySynthesis(data);

            } catch (error) {
                console.error('Error loading synthesis:', error);
                showEmptySynthesis();
            }
        }

        // Display synthesis content
        function displaySynthesis(data) {
            document.getElementById('synthesis-empty').style.display = 'none';
            document.getElementById('takeaways-content').style.display = 'block';
            document.getElementById('synthesis-content').style.display = 'block';

            // Check version
            const isV3 = data.version === '3.0' || data.confluence_zones || data.attention_priorities;

            // Update meta info
            document.getElementById('synthesis-window').textContent = data.time_window;
            document.getElementById('synthesis-count').textContent = data.content_count;
            document.getElementById('synthesis-time').textContent = data.generated_at ? formatDateTime(parseUTCDate(data.generated_at)) : '-';

            // Populate Key Takeaways (max 5 bullets)
            const takeawaysList = document.getElementById('takeaways-list');
            const execSummary = data.executive_summary || {};
            const keyTakeaways = execSummary.key_takeaways || [];

            if (keyTakeaways.length > 0) {
                takeawaysList.innerHTML = keyTakeaways.slice(0, 5).map(t =>
                    `<li style="margin-bottom: var(--spacing-xs); line-height: var(--leading-relaxed);">${t}</li>`
                ).join('');
            } else {
                // Fallback: extract from synthesis summary
                const synthesisSummary = data.synthesis_summary || data.synthesis || '';
                // Better sentence splitting that handles abbreviations
                const sentences = synthesisSummary
                    .split(/(?<=[.!?])\s+(?=[A-Z])/)
                    .filter(s => s.trim().length > 20)
                    .slice(0, 5);
                if (sentences.length > 0) {
                    takeawaysList.innerHTML = sentences.map(s =>
                        `<li style="margin-bottom: var(--spacing-xs); line-height: var(--leading-relaxed);">${s.trim()}.</li>`
                    ).join('');
                } else {
                    takeawaysList.innerHTML = '<li style="color: var(--text-muted);">No key takeaways available.</li>';
                }
            }

            // Update market regime badge
            let regimeValue = data.market_regime;
            if (typeof regimeValue === 'object' && regimeValue !== null) {
                regimeValue = regimeValue.current;
            }
            if (regimeValue) {
                const regimeClass = `regime-${regimeValue.replace('_', '-').replace(' ', '-')}`;
                document.getElementById('market-regime-badge').innerHTML = `<span class="market-regime ${regimeClass}">${regimeValue}</span>`;
            }

            // Synthesis text
            const synthText = document.getElementById('synthesis-text');
            const synthesisContent = data.synthesis_summary || data.synthesis || '';
            const paragraphs = synthesisContent.split('\n\n').filter(p => p.trim());
            synthText.innerHTML = paragraphs.map(p => `<p style="margin-bottom: var(--spacing-sm);">${p}</p>`).join('');

            // Theme tags
            const themeTags = document.getElementById('theme-tags');
            const themes = data.key_themes || [];
            if (themes.length > 0) {
                themeTags.innerHTML = themes.map(theme =>
                    `<span class="badge" style="background: var(--glass-bg); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-full); font-size: var(--text-xs);">${theme}</span>`
                ).join('');
            }

            // Handle V3 content
            if (isV3) {
                document.getElementById('v3-content').style.display = 'block';
                document.getElementById('synthesis-text').style.display = 'none';
                document.getElementById('theme-tags').style.display = 'none';

                displayV3ExecutiveSummary(data.executive_summary || {});
                displayV3AttentionPriorities(data.attention_priorities || []);
                displayV3ConfluenceZones(data.confluence_zones || []);
                displayV3ConflictWatch(data.conflict_watch || []);
                displayV3SourceStances(data.source_stances || {});
            }
        }

        // V3: Display executive summary
        function displayV3ExecutiveSummary(summary) {
            const container = document.getElementById('v3-executive-section');
            if (!summary || (!summary.narrative && !summary.synthesis_narrative)) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const tone = summary.overall_tone || 'uncertain';
            const isEnhanced = summary.source_highlights || summary.synthesis_narrative;

            if (isEnhanced) {
                const macroContext = summary.macro_context || '';
                const synthesisNarrative = summary.synthesis_narrative || '';
                const keyTakeaways = summary.key_takeaways || [];

                container.innerHTML = `
                    ${macroContext ? `<div style="font-size: var(--text-lg); margin-bottom: var(--spacing-md); color: var(--text-primary);">${macroContext}</div>` : ''}
                    ${synthesisNarrative ? `<div style="color: var(--text-secondary); line-height: var(--leading-relaxed);">${synthesisNarrative}</div>` : ''}
                    ${keyTakeaways.length > 0 ? `
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg);">
                            <div style="font-weight: var(--font-semibold); margin-bottom: var(--spacing-sm);">Key Takeaways</div>
                            <ol style="margin: 0; padding-left: var(--spacing-lg);">
                                ${keyTakeaways.map(t => `<li style="margin-bottom: var(--spacing-xs);">${t}</li>`).join('')}
                            </ol>
                        </div>
                    ` : ''}
                    <div style="margin-top: var(--spacing-md);">
                        <span class="badge" style="background: var(--${tone === 'bullish' ? 'success' : tone === 'bearish' ? 'danger' : 'warning'}); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-full); font-size: var(--text-xs);">${tone}</span>
                    </div>
                `;
            } else {
                container.innerHTML = `<div style="color: var(--text-secondary);">${summary.narrative}</div>`;
            }
        }

        // V3: Display attention priorities
        function displayV3AttentionPriorities(priorities) {
            const container = document.getElementById('v3-priorities-list');
            const section = document.getElementById('priorities-section');

            if (!priorities || priorities.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = priorities.map(p => `
                <div style="display: flex; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm);">
                    <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-weight: var(--font-bold); flex-shrink: 0;">${p.rank || '?'}</div>
                    <div>
                        <div style="font-weight: var(--font-semibold);">${p.focus_area || 'Untitled'}</div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">${p.why || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // V3: Display confluence zones
        function displayV3ConfluenceZones(zones) {
            const container = document.getElementById('v3-confluence-list');
            const section = document.getElementById('confluence-section');

            if (!zones || zones.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = zones.map(zone => {
                const strength = zone.confluence_strength || 0;
                const aligned = zone.sources_aligned || [];
                return `
                    <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--success);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-semibold);">${zone.theme || 'Untitled'}</span>
                            <span style="font-size: var(--text-sm); color: var(--success);">${Math.round(strength * 100)}% alignment</span>
                        </div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                            ${aligned.map(s => `<div><strong>${s.source}:</strong> ${s.view}</div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // V3: Display conflict watch
        function displayV3ConflictWatch(conflicts) {
            const container = document.getElementById('v3-conflict-list');
            const section = document.getElementById('conflict-section');

            if (!conflicts || conflicts.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = conflicts.map(c => `
                <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--warning);">
                    <div style="font-weight: var(--font-semibold); margin-bottom: var(--spacing-sm);">${c.topic || 'Untitled'}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); font-size: var(--text-sm);">
                        <div style="padding: var(--spacing-sm); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md);">
                            <div style="color: var(--success); font-weight: var(--font-medium);">Bull Case</div>
                            <div style="color: var(--text-secondary);">${c.bull_case?.view || '-'}</div>
                        </div>
                        <div style="padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
                            <div style="color: var(--danger); font-weight: var(--font-medium);">Bear Case</div>
                            <div style="color: var(--text-secondary);">${c.bear_case?.view || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // V3: Display source stances
        function displayV3SourceStances(stances) {
            const container = document.getElementById('v3-stances-list');
            const section = document.getElementById('stances-section');

            if (!stances || Object.keys(stances).length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = Object.entries(stances).map(([name, data]) => {
                const bias = data.overall_bias || 'neutral';
                const biasColor = bias === 'bullish' ? 'success' : bias === 'bearish' ? 'danger' : 'warning';
                return `
                    <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                            <span style="font-weight: var(--font-semibold);">${name}</span>
                            <span class="badge" style="background: var(--${biasColor}); color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px;">${bias}</span>
                        </div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">${data.current_stance_narrative || ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Show empty synthesis state
        function showEmptySynthesis() {
            // Show empty state in takeaways section
            document.getElementById('synthesis-empty').style.display = 'block';
            document.getElementById('takeaways-content').style.display = 'none';

            // Hide full synthesis panel
            document.getElementById('synthesis-panel').style.display = 'none';

            // Hide all V3 sections (they show when data is available)
            document.getElementById('priorities-section').style.display = 'none';
            document.getElementById('confluence-section').style.display = 'none';
            document.getElementById('conflict-section').style.display = 'none';
            document.getElementById('stances-section').style.display = 'none';
        }

        // Toggle full synthesis panel visibility
        function toggleFullSynthesis() {
            const panel = document.getElementById('synthesis-panel');
            const btn = document.getElementById('view-full-synthesis-btn');
            const isHidden = panel.style.display === 'none';

            panel.style.display = isHidden ? 'block' : 'none';

            if (btn) {
                btn.innerHTML = isHidden
                    ? '<span class="icon">üìÑ</span><span>Hide Full Synthesis</span>'
                    : '<span class="icon">üìÑ</span><span>View Full Synthesis</span>';
            }

            // Scroll to panel when opening
            if (isHidden) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Trigger collection
        async function triggerCollection(sourceName) {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="icon">‚è≥</span><span>Collecting...</span>';

            try {
                const response = await fetch(`${API_BASE}/collect/trigger/${sourceName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (response.ok) {
                    btn.innerHTML = `<span class="icon">‚úì</span><span>Done (${data.saved || 0} new)</span>`;
                    await loadStatus();
                    setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed');
                }
            } catch (error) {
                console.error('Collection error:', error);
                btn.innerHTML = '<span class="icon">‚úï</span><span>Error</span>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // Analyze content
        async function analyzeContent() {
            const btn = document.getElementById('btn-analyze');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            let totalAnalyzed = 0;
            let batchCount = 0;

            try {
                btn.innerHTML = `<span class="icon">‚ö°</span><span class="btn-text">Starting...</span>`;

                while (true) {
                    batchCount++;
                    const response = await fetch(`${API_BASE}/analyze/classify-batch?limit=50`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.detail);

                    if (data.count > 0) {
                        totalAnalyzed += data.count;
                        btn.innerHTML = `<span class="icon">‚ö°</span><span class="btn-text">Analyzed: ${totalAnalyzed}</span>`;
                        // Small delay to ensure UI updates are visible
                        await new Promise(r => setTimeout(r, 100));
                    } else {
                        break;
                    }

                    // Safety: max 20 batches to prevent infinite loop
                    if (batchCount >= 20) {
                        console.log('[Analyze] Max batches reached');
                        break;
                    }
                }

                btn.innerHTML = `<span class="icon">‚úì</span><span class="btn-text">Done (${totalAnalyzed})</span>`;
                await loadStatus();
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                console.error('Analysis error:', error);
                btn.innerHTML = `<span class="icon">‚úï</span><span class="btn-text">Error</span>`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // Generate synthesis
        async function generateSynthesis(timeWindow) {
            const btn = timeWindow === '24h' ? document.getElementById('btn-generate-24h') : document.getElementById('btn-generate-7d');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;

            // Start elapsed time counter
            let seconds = 0;
            const timerInterval = setInterval(() => {
                seconds++;
                btn.innerHTML = `<span class="icon">‚è≥</span><span class="btn-text">Generating... ${seconds}s</span>`;
            }, 1000);

            try {
                btn.innerHTML = `<span class="icon">‚è≥</span><span class="btn-text">Generating... 0s</span>`;

                const response = await fetch(`${API_BASE}/synthesis/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ time_window: timeWindow })
                });
                const data = await response.json();

                clearInterval(timerInterval);

                if (data.status === 'success') {
                    await loadLatestSynthesis();
                    await loadStatus();
                    btn.innerHTML = `<span class="icon">‚úì</span><span class="btn-text">Done (${seconds}s)</span>`;
                } else if (data.status === 'no_content') {
                    alert(data.message || 'No content available');
                    btn.innerHTML = originalHTML;
                } else {
                    throw new Error(data.detail || 'Failed');
                }
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                clearInterval(timerInterval);
                console.error('Generation error:', error);
                btn.innerHTML = `<span class="icon">‚úï</span><span class="btn-text">Error</span>`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // =====================================================
        // THEMES TAB
        // =====================================================
        let allThemes = [];
        let currentThemeFilter = 'all';

        async function loadThemes() {
            try {
                const summaryResponse = await fetch(`${API_BASE}/themes/summary`);
                const summary = await summaryResponse.json();

                document.getElementById('themes-total').textContent = summary.total || 0;
                document.getElementById('themes-active').textContent = summary.by_status?.active || 0;
                document.getElementById('themes-emerging').textContent = summary.by_status?.emerging || 0;
                document.getElementById('themes-evolved').textContent = summary.by_status?.evolved || 0;
                document.getElementById('kpi-themes').textContent = summary.by_status?.active || 0;

                const themesResponse = await fetch(`${API_BASE}/themes`);
                const themesData = await themesResponse.json();
                allThemes = themesData.themes || [];
                displayThemes(allThemes);

            } catch (error) {
                console.error('Error loading themes:', error);
            }
        }

        function filterThemes(status, btnEl) {
            currentThemeFilter = status;
            document.querySelectorAll('#panel-themes .tabs-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');

            let filtered = status === 'all' ? allThemes : allThemes.filter(t => t.status === status);
            displayThemes(filtered);
        }

        function displayThemes(themes) {
            const container = document.getElementById('themes-list');
            if (!themes || themes.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìã</div>
                        <h3>No Themes Found</h3>
                        <p style="color: var(--text-muted);">${currentThemeFilter === 'all' ? 'Themes will be extracted from synthesis.' : `No ${currentThemeFilter} themes.`}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = themes.map(theme => {
                const statusColor = theme.status === 'active' ? 'success' : theme.status === 'emerging' ? 'warning' : theme.status === 'evolved' ? 'primary' : 'text-muted';
                return `
                    <div class="sidebar-card" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-semibold);">${theme.name}</span>
                            <span class="badge" style="background: var(--${statusColor}); color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px;">${theme.status}</span>
                        </div>
                        ${theme.description ? `<p style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-sm);">${theme.description}</p>` : ''}
                        <div style="font-size: var(--text-xs); color: var(--text-muted);">
                            Evidence: ${theme.evidence_count || 0} items
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================
        // SOURCES TAB
        // =====================================================
        let sourcesLoaded = false;
        let currentSourceView = 'list'; // 'list' or 'detail'
        let currentSourceName = null;

        async function loadSources() {
            if (sourcesLoaded && currentSourceView === 'list') return;

            const container = document.getElementById('sources-detail-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading sources...</p>';

            try {
                const response = await fetch(`${API_BASE}/dashboard/sources`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const sources = await response.json();
                displaySources(sources);
                sourcesLoaded = true;
                currentSourceView = 'list';
            } catch (error) {
                console.error('Error loading sources:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading Sources</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                    </div>
                `;
            }
        }

        function displaySources(sources) {
            const container = document.getElementById('sources-detail-list');

            if (!sources || sources.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üì°</div>
                        <h3>No Sources Found</h3>
                        <p style="color: var(--text-muted);">No data sources have been configured.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md);">
                    ${sources.map(source => {
                        const lastCollected = source.last_collected ? formatTimeAgo(parseUTCDate(source.last_collected)) : 'Never';
                        const statusColor = source.active ? 'var(--success)' : 'var(--text-muted)';
                        const statusText = source.active ? 'Active' : 'Inactive';

                        return `
                            <div class="sidebar-card source-card" onclick="loadSourceDetail('${source.name}')" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                                    <span style="font-weight: var(--font-semibold); font-size: var(--text-lg);">${source.name}</span>
                                    <span style="display: flex; align-items: center; gap: 4px; font-size: var(--text-xs);">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></span>
                                        ${statusText}
                                    </span>
                                </div>
                                <div style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                                    Type: ${source.type}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); font-size: var(--text-sm);">
                                    <div>
                                        <div style="color: var(--text-muted);">Total Items</div>
                                        <div style="font-weight: var(--font-semibold);">${source.total_items || 0}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">Analyzed</div>
                                        <div style="font-weight: var(--font-semibold);">${source.analyzed_items || 0}</div>
                                    </div>
                                </div>
                                <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-sm); border-top: 1px solid var(--border-subtle); font-size: var(--text-xs); color: var(--text-muted);">
                                    Last collected: ${lastCollected}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function loadSourceDetail(sourceName) {
            currentSourceName = sourceName;
            currentSourceView = 'detail';

            const container = document.getElementById('sources-detail-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading content...</p>';

            try {
                const response = await fetch(`${API_BASE}/dashboard/sources/${sourceName}?limit=20`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const content = await response.json();
                displaySourceDetail(sourceName, content);
            } catch (error) {
                console.error('Error loading source detail:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading Content</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadSources()" style="margin-top: var(--spacing-md);">‚Üê Back to Sources</button>
                    </div>
                `;
            }
        }

        function displaySourceDetail(sourceName, content) {
            const container = document.getElementById('sources-detail-list');

            const backButton = `
                <button class="btn btn-secondary" onclick="sourcesLoaded = false; loadSources();" style="margin-bottom: var(--spacing-md);">
                    ‚Üê Back to Sources
                </button>
            `;

            if (!content || content.length === 0) {
                container.innerHTML = `
                    ${backButton}
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üì≠</div>
                        <h3>No Content</h3>
                        <p style="color: var(--text-muted);">No content has been collected from ${sourceName} yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                ${backButton}
                <h3 style="margin-bottom: var(--spacing-md);">${sourceName} - Recent Content (${content.length} items)</h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    ${content.map(item => {
                        const collectedAt = item.collected_at ? formatTimeAgo(parseUTCDate(item.collected_at)) : '-';
                        const sentiment = item.sentiment || 'neutral';
                        const sentimentColor = sentiment === 'bullish' ? 'var(--success)' : sentiment === 'bearish' ? 'var(--danger)' : 'var(--text-muted)';

                        return `
                            <div class="sidebar-card" style="padding: var(--spacing-sm) var(--spacing-md);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--spacing-md);">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: var(--font-medium); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${item.title || 'Untitled'}
                                        </div>
                                        ${item.summary ? `<div style="font-size: var(--text-sm); color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${item.summary}</div>` : ''}
                                    </div>
                                    <div style="flex-shrink: 0; text-align: right; font-size: var(--text-xs);">
                                        <div style="color: var(--text-muted);">${collectedAt}</div>
                                        <div style="color: ${sentimentColor}; text-transform: capitalize;">${sentiment}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // =====================================================
        // HISTORY TAB
        // =====================================================
        let historyLoaded = false;
        let currentHistoryView = 'list'; // 'list' or 'detail'
        let historyOffset = 0;
        const historyLimit = 10;

        async function loadHistory(offset = 0) {
            if (historyLoaded && currentHistoryView === 'list' && offset === historyOffset) return;

            historyOffset = offset;
            const container = document.getElementById('synthesis-history-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading history...</p>';

            try {
                const response = await fetch(`${API_BASE}/synthesis/history?limit=${historyLimit}&offset=${offset}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                displayHistory(data);
                historyLoaded = true;
                currentHistoryView = 'list';
            } catch (error) {
                console.error('Error loading history:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading History</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                    </div>
                `;
            }
        }

        function displayHistory(data) {
            const container = document.getElementById('synthesis-history-list');
            const { syntheses, total, limit, offset } = data;

            if (!syntheses || syntheses.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìú</div>
                        <h3>No Synthesis History</h3>
                        <p style="color: var(--text-muted);">Generate a synthesis to see it here.</p>
                    </div>
                `;
                return;
            }

            const pagination = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <span style="font-size: var(--text-sm); color: var(--text-muted);">
                        Showing ${offset + 1}-${Math.min(offset + syntheses.length, total)} of ${total}
                    </span>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn btn-secondary btn-sm" onclick="loadHistory(${Math.max(0, offset - limit)})" ${offset === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="loadHistory(${offset + limit})" ${offset + limit >= total ? 'disabled' : ''}>
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = `
                ${pagination}
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    ${syntheses.map(synth => {
                        const generatedAt = synth.generated_at ? formatDateTime(parseUTCDate(synth.generated_at)) : '-';
                        const regimeColor = synth.market_regime === 'risk-on' ? 'var(--success)' :
                                           synth.market_regime === 'risk-off' ? 'var(--danger)' : 'var(--warning)';
                        const themes = synth.key_themes || [];

                        return `
                            <div class="sidebar-card" onclick="loadSynthesisDetail(${synth.id})" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm);">
                                    <div>
                                        <div style="font-weight: var(--font-semibold);">${generatedAt}</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-muted);">
                                            ${synth.time_window} window ‚Ä¢ ${synth.content_count || 0} items
                                        </div>
                                    </div>
                                    <span style="background: ${regimeColor}; color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px; text-transform: capitalize;">
                                        ${synth.market_regime || 'unknown'}
                                    </span>
                                </div>
                                ${synth.synthesis_preview ? `
                                    <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-sm); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                        ${synth.synthesis_preview}
                                    </p>
                                ` : ''}
                                ${themes.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                        ${themes.slice(0, 4).map(t => `
                                            <span style="background: var(--bg-elevated); padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px; color: var(--text-secondary);">
                                                ${typeof t === 'string' ? t : t.theme || t.name || 'Theme'}
                                            </span>
                                        `).join('')}
                                        ${themes.length > 4 ? `<span style="font-size: 10px; color: var(--text-muted);">+${themes.length - 4} more</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                ${pagination}
            `;
        }

        async function loadSynthesisDetail(synthesisId) {
            currentHistoryView = 'detail';

            const container = document.getElementById('synthesis-history-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Loading synthesis...</p>';

            try {
                const response = await fetch(`${API_BASE}/synthesis/${synthesisId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const synthesis = await response.json();
                displaySynthesisDetail(synthesis);
            } catch (error) {
                console.error('Error loading synthesis:', error);
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                        <h3>Error Loading Synthesis</h3>
                        <p style="color: var(--text-muted);">${error.message}</p>
                        <button class="btn btn-secondary" onclick="historyLoaded = false; loadHistory();" style="margin-top: var(--spacing-md);">‚Üê Back to History</button>
                    </div>
                `;
            }
        }

        function displaySynthesisDetail(synth) {
            const container = document.getElementById('synthesis-history-list');
            const generatedAt = synth.generated_at ? formatDateTime(parseUTCDate(synth.generated_at)) : '-';

            const backButton = `
                <button class="btn btn-secondary" onclick="historyLoaded = false; loadHistory();" style="margin-bottom: var(--spacing-md);">
                    ‚Üê Back to History
                </button>
            `;

            const themes = synth.key_themes || [];
            const ideas = synth.high_conviction_ideas || [];
            const contradictions = synth.contradictions || [];
            const catalysts = synth.catalysts || [];

            container.innerHTML = `
                ${backButton}
                <div class="sidebar-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                        <div>
                            <h3 style="margin: 0;">Synthesis #${synth.id}</h3>
                            <div style="font-size: var(--text-sm); color: var(--text-muted);">${generatedAt}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: var(--text-sm);">${synth.time_window} window</div>
                            <div style="font-size: var(--text-xs); color: var(--text-muted);">${synth.content_count || 0} items analyzed</div>
                        </div>
                    </div>

                    ${synth.market_regime ? `
                        <div style="margin-bottom: var(--spacing-md);">
                            <span style="font-size: var(--text-sm); color: var(--text-muted);">Market Regime:</span>
                            <span style="font-weight: var(--font-semibold); text-transform: capitalize;"> ${synth.market_regime}</span>
                        </div>
                    ` : ''}

                    ${synth.synthesis ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Summary</h4>
                            <p style="font-size: var(--text-sm); color: var(--text-secondary); white-space: pre-wrap;">${synth.synthesis}</p>
                        </div>
                    ` : ''}

                    ${themes.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Key Themes (${themes.length})</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                                ${themes.map(t => `
                                    <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: var(--radius-full); font-size: var(--text-sm);">
                                        ${typeof t === 'string' ? t : t.theme || t.name || 'Theme'}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${ideas.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">High Conviction Ideas (${ideas.length})</h4>
                            <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                                ${ideas.map(idea => `<li style="margin-bottom: 4px;">${typeof idea === 'string' ? idea : idea.idea || idea.description || JSON.stringify(idea)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${contradictions.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Contradictions (${contradictions.length})</h4>
                            <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                                ${contradictions.map(c => `<li style="margin-bottom: 4px;">${typeof c === 'string' ? c : c.description || c.conflict || JSON.stringify(c)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${catalysts.length > 0 ? `
                        <div>
                            <h4 style="margin-bottom: var(--spacing-sm);">Catalysts (${catalysts.length})</h4>
                            <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                                ${catalysts.map(c => `<li style="margin-bottom: 4px;">${typeof c === 'string' ? c : c.event || c.description || JSON.stringify(c)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // =====================================================
        // UTILITIES
        // =====================================================
        function parseUTCDate(isoString) {
            if (!isoString) return null;
            if (!isoString.endsWith('Z') && !isoString.includes('+') && !isoString.includes('-', 10)) {
                isoString = isoString + 'Z';
            }
            return new Date(isoString);
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function formatDateTime(date) {
            if (!date) return '-';
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // =====================================================
        // REFRESH CURRENT TAB
        // =====================================================
        async function refreshCurrentTab() {
            // Find active tab
            const activeTab = document.querySelector('.tab-btn.active');
            const tabName = activeTab ? activeTab.dataset.tab : 'overview';

            console.log('[Refresh] Refreshing tab:', tabName);

            // Force refresh by resetting loaded flags
            switch (tabName) {
                case 'overview':
                    await Promise.all([loadStatus(), loadLatestSynthesis()]);
                    break;
                case 'themes':
                    await loadThemes();
                    break;
                case 'sources':
                    sourcesLoaded = false;
                    await loadSources();
                    break;
                case 'history':
                    historyLoaded = false;
                    await loadHistory();
                    break;
            }
        }

        // =====================================================
        // TAB CHANGE EVENT HANDLER
        // =====================================================
        window.addEventListener('tabchange', (e) => {
            const tab = e.detail.tab;
            console.log('[Tab] Switched to:', tab);

            if (tab === 'themes') {
                loadThemes();
            } else if (tab === 'sources') {
                loadSources();
            } else if (tab === 'history') {
                loadHistory();
            }
        });

        // Handle initial page load with hash
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.slice(1);
            if (hash === 'sources') {
                loadSources();
            } else if (hash === 'history') {
                loadHistory();
            } else if (hash === 'themes') {
                loadThemes();
            }
        });
    </script>

    <!-- Navigation & UI Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/accessibility.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/toast.js"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Chart Component Scripts -->
    <script src="js/charts/chartConfig.js"></script>
    <script src="js/charts/confluenceRadar.js"></script>
    <script src="js/charts/sourceDonut.js"></script>
    <script src="js/charts/themeTimeline.js"></script>
    <script src="js/charts/sentimentGauge.js"></script>
    <script src="js/charts/convictionBar.js"></script>
    <script src="js/charts/confluenceHeatmap.js"></script>
    <script src="js/charts/index.js"></script>
</body>
</html>
