<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="AI-powered investment research synthesis and confluence analysis">
    <meta name="theme-color" content="#0F172A">
    <title>Macro Confluence Hub</title>

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Modern Design System + Layout -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/layout.css">
</head>
<body>
    <!-- Skip to main content (accessibility) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header (Sticky, Glassmorphic) -->
    <header class="site-header" id="site-header">
        <div class="header-container">
            <!-- Logo -->
            <a href="/" class="header-logo">
                <span class="logo-icon">üìä</span>
                <span class="logo-text">Confluence<span class="logo-accent">Hub</span></span>
            </a>

            <!-- Search (Desktop) -->
            <div class="header-search desktop-only">
                <button class="search-trigger" id="search-trigger">
                    <span class="search-icon">üîç</span>
                    <span class="search-placeholder">Search research...</span>
                    <kbd class="search-shortcut">‚åòK</kbd>
                </button>
            </div>

            <!-- Header Actions -->
            <div class="header-actions">
                <!-- Connection Status -->
                <div class="connection-status">
                    <span class="live-dot"></span>
                    <span class="status-text desktop-only">Live</span>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Drawer -->
    <nav class="mobile-nav" id="mobile-nav" aria-hidden="true">
        <div class="mobile-nav-overlay"></div>
        <div class="mobile-nav-panel">
            <div class="mobile-nav-header">
                <span class="logo-text">Confluence<span class="logo-accent">Hub</span></span>
                <button class="mobile-nav-close" id="mobile-nav-close">‚úï</button>
            </div>
            <ul class="mobile-nav-links">
                <li><a href="#overview" class="mobile-nav-link active" data-tab="overview">Overview</a></li>
                <li><a href="#themes" class="mobile-nav-link" data-tab="themes">Themes</a></li>
                <li><a href="#sources" class="mobile-nav-link" data-tab="sources">Sources</a></li>
                <li><a href="#history" class="mobile-nav-link" data-tab="history">History</a></li>
            </ul>
            <div class="mobile-nav-actions">
                <button class="fab-btn fab-btn-primary w-full" onclick="generateSynthesis('24h')">Generate Synthesis</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <div class="container">

            <!-- Hero Section -->
            <section class="hero-section" id="hero-section">
                <div class="hero-grid">
                    <!-- Market Regime -->
                    <div class="hero-regime">
                        <div class="regime-label">Market Regime</div>
                        <div class="regime-badge regime-badge-uncertain" id="hero-regime-badge">
                            <span class="regime-icon">‚ö°</span>
                            <span class="regime-text" id="hero-regime-text">Loading...</span>
                        </div>
                        <div class="regime-meta">
                            <span>Last updated:</span>
                            <span id="hero-last-updated">-</span>
                        </div>
                    </div>

                    <!-- Key Insight -->
                    <div class="hero-insight">
                        <div class="insight-label">Key Insight</div>
                        <p class="insight-text" id="hero-key-insight">
                            Loading latest synthesis...
                        </p>
                        <div class="insight-sources">
                            <span style="color: var(--text-muted);">Primary:</span>
                            <span id="hero-sources">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- KPI Grid -->
            <section class="kpi-section" id="kpi-section">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Content (24h)</div>
                        <div class="kpi-value">
                            <span class="data-large" id="content-24h">-</span>
                        </div>
                        <div class="kpi-meta">items collected</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Content (7d)</div>
                        <div class="kpi-value">
                            <span class="data-large" id="content-7d">-</span>
                        </div>
                        <div class="kpi-meta">items collected</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Active Themes</div>
                        <div class="kpi-value">
                            <span class="data-large" id="kpi-themes">-</span>
                        </div>
                        <div class="kpi-meta">across sources</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">Last Synthesis</div>
                        <div class="kpi-value">
                            <span class="data-large" id="last-synthesis-time">-</span>
                        </div>
                        <div class="kpi-meta" id="last-synthesis-window">-</div>
                    </div>
                </div>
            </section>

            <!-- Tab Navigation -->
            <section class="tabs-section">
                <div class="tabs-header">
                    <div class="tabs-nav" role="tablist">
                        <button class="tab-btn active" role="tab" data-tab="overview" aria-selected="true">Overview</button>
                        <button class="tab-btn" role="tab" data-tab="themes" aria-selected="false">Themes</button>
                        <button class="tab-btn" role="tab" data-tab="sources" aria-selected="false">Sources</button>
                        <button class="tab-btn" role="tab" data-tab="history" aria-selected="false">History</button>
                    </div>

                    <div class="tabs-filter">
                        <select class="time-filter" id="time-filter">
                            <option value="24h">Last 24 hours</option>
                            <option value="7d" selected>Last 7 days</option>
                            <option value="30d">Last 30 days</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Tab Content -->
            <section class="tab-content-area">
                <!-- Overview Tab -->
                <div class="tab-panel active" id="panel-overview" role="tabpanel">
                    <div class="content-grid">
                        <!-- Main Column -->
                        <div class="content-main">
                            <!-- Synthesis Panel -->
                            <div class="sidebar-card" id="synthesis-panel">
                                <div class="synthesis-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-subtle);">
                                    <div>
                                        <div class="section-title" style="margin-bottom: var(--spacing-xs);">Research Synthesis</div>
                                        <div class="synthesis-meta" style="font-size: var(--text-sm); color: var(--text-muted);">
                                            <span id="synthesis-window">-</span> analysis |
                                            <span id="synthesis-count">0</span> items |
                                            <span id="synthesis-time">-</span>
                                        </div>
                                    </div>
                                    <div id="market-regime-badge"></div>
                                </div>

                                <!-- Empty State -->
                                <div id="synthesis-empty" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
                                    <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìä</div>
                                    <h3 style="margin-bottom: var(--spacing-sm);">No Synthesis Available</h3>
                                    <p>Click "Generate Synthesis" to create an AI summary.</p>
                                </div>

                                <!-- Synthesis Content (hidden initially) -->
                                <div id="synthesis-content" style="display: none;">
                                    <div class="synthesis-text" id="synthesis-text"></div>
                                    <div class="theme-tags" id="theme-tags" style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin-top: var(--spacing-md);"></div>

                                    <!-- V3 Content -->
                                    <div id="v3-content" style="display: none;">
                                        <div id="v3-executive-section" class="v3-executive-summary"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Confluence Zones -->
                            <div class="sidebar-card" id="confluence-section" style="display: none;">
                                <div class="section-title">Confluence Zones</div>
                                <div id="v3-confluence-list"></div>
                            </div>

                            <!-- Attention Priorities (in main for V3) -->
                            <div class="sidebar-card" id="priorities-section" style="display: none;">
                                <div class="section-title">This Week's Focus</div>
                                <div id="v3-priorities-list"></div>
                            </div>

                            <!-- Conflict Watch -->
                            <div class="sidebar-card" id="conflict-section" style="display: none;">
                                <div class="section-title">Conflicts to Monitor</div>
                                <div id="v3-conflict-list"></div>
                            </div>

                            <!-- Charts Section (PRD-031) -->
                            <div class="sidebar-card charts-section">
                                <div class="section-title">Market Visualization</div>
                                <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                                    <div class="chart-container chart-container-sm" data-chart="sentiment-gauge" data-chart-type="sentiment-gauge">
                                        <div class="chart-header"><span class="chart-title">Sentiment</span></div>
                                        <div class="chart-canvas-wrapper"><canvas id="sentiment-gauge-canvas"></canvas></div>
                                    </div>
                                    <div class="chart-container chart-container-sm" data-chart="source-donut" data-chart-type="source-donut">
                                        <div class="chart-header"><span class="chart-title">Sources</span></div>
                                        <div class="chart-canvas-wrapper"><canvas id="source-donut-canvas"></canvas></div>
                                    </div>
                                    <div class="chart-container chart-container-sm" data-chart="conviction-bar" data-chart-type="conviction-bar">
                                        <div class="chart-header"><span class="chart-title">Conviction</span></div>
                                        <div class="chart-canvas-wrapper"><canvas id="conviction-bar-canvas"></canvas></div>
                                    </div>
                                    <div class="chart-container chart-container-sm" data-chart="confluence-heatmap" data-chart-type="confluence-heatmap" id="confluence-heatmap">
                                        <div class="chart-header"><span class="chart-title">Confluence</span></div>
                                        <div class="chart-canvas-wrapper"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <aside class="content-sidebar">
                            <!-- Source Status -->
                            <div class="sidebar-card">
                                <div class="sidebar-title">Source Status</div>
                                <div id="source-status-list" class="source-list">
                                    <div style="color: var(--text-muted);">Loading...</div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="sidebar-card">
                                <div class="sidebar-title">Quick Actions</div>
                                <div class="quick-actions" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                    <button class="fab-btn fab-btn-secondary w-full" onclick="triggerCollection('youtube')">
                                        <span class="icon">‚ñ∂Ô∏è</span>
                                        <span>Collect YouTube</span>
                                    </button>
                                    <button class="fab-btn fab-btn-secondary w-full" onclick="triggerCollection('substack')">
                                        <span class="icon">üì∞</span>
                                        <span>Collect Substack</span>
                                    </button>
                                    <button class="fab-btn fab-btn-secondary w-full" onclick="triggerCollection('kt_technical')">
                                        <span class="icon">üìà</span>
                                        <span>Collect KT Technical</span>
                                    </button>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); text-align: center; margin-top: var(--spacing-sm);">
                                        Discord & 42 Macro run locally
                                    </div>
                                </div>
                            </div>

                            <!-- Source Stances -->
                            <div class="sidebar-card" id="stances-section" style="display: none;">
                                <div class="sidebar-title">Source Perspectives</div>
                                <div id="v3-stances-list"></div>
                            </div>
                        </aside>
                    </div>
                </div>

                <!-- Themes Tab -->
                <div class="tab-panel" id="panel-themes" role="tabpanel">
                    <!-- Themes Stats -->
                    <div class="kpi-grid" style="margin-bottom: var(--spacing-lg);">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Themes</div>
                            <div class="kpi-value"><span class="data-large" id="themes-total">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Active</div>
                            <div class="kpi-value"><span class="data-large" id="themes-active">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Emerging</div>
                            <div class="kpi-value"><span class="data-large" id="themes-emerging">0</span></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Evolved</div>
                            <div class="kpi-value"><span class="data-large" id="themes-evolved">0</span></div>
                        </div>
                    </div>

                    <!-- Themes Filters -->
                    <div class="tabs-nav" style="margin-bottom: var(--spacing-lg);">
                        <button class="tab-btn active" onclick="filterThemes('all', this)">All</button>
                        <button class="tab-btn" onclick="filterThemes('active', this)">Active</button>
                        <button class="tab-btn" onclick="filterThemes('emerging', this)">Emerging</button>
                        <button class="tab-btn" onclick="filterThemes('evolved', this)">Evolved</button>
                        <button class="tab-btn" onclick="filterThemes('dormant', this)">Dormant</button>
                    </div>

                    <!-- Themes List -->
                    <div id="themes-list" class="content-main">
                        <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                            <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìã</div>
                            <h3>No Themes Yet</h3>
                            <p style="color: var(--text-muted);">Themes will be extracted from synthesis.</p>
                        </div>
                    </div>
                </div>

                <!-- Sources Tab -->
                <div class="tab-panel" id="panel-sources" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Source Overview</div>
                            <div id="sources-detail-list">
                                <p style="color: var(--text-muted);">Loading source details...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-panel" id="panel-history" role="tabpanel">
                    <div class="content-main">
                        <div class="sidebar-card">
                            <div class="section-title">Synthesis History</div>
                            <div id="synthesis-history-list">
                                <p style="color: var(--text-muted);">Coming soon...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Floating Action Bar -->
    <div class="floating-action-bar" id="floating-actions">
        <div class="fab-container">
            <button class="fab-btn fab-btn-warning" id="btn-analyze" onclick="analyzeContent()">
                <span class="icon">‚ö°</span>
                <span class="btn-text">Analyze</span>
            </button>
            <button class="fab-btn fab-btn-primary" id="btn-generate-24h" onclick="generateSynthesis('24h')">
                <span class="icon">üìù</span>
                <span class="btn-text">Generate 24h</span>
            </button>
            <button class="fab-btn fab-btn-secondary" id="btn-generate-7d" onclick="generateSynthesis('7d')">
                <span class="icon">üìä</span>
                <span class="btn-text">Generate 7-Day</span>
            </button>
            <button class="fab-btn fab-btn-ghost" onclick="loadStatus(); loadLatestSynthesis();">
                <span class="icon">üîÑ</span>
                <span class="btn-text desktop-only">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="search-modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="search-modal-header">
                <span class="search-icon">üîç</span>
                <input type="search" class="search-modal-input" placeholder="Search themes, sources, content..." autofocus>
                <kbd class="search-modal-esc">ESC</kbd>
            </div>
            <div class="search-modal-results" id="search-results">
                <p style="color: var(--text-muted); text-align: center; padding: var(--spacing-lg);">
                    Type to search across your research...
                </p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Application JavaScript -->
    <script>
        // API Base URL
        const API_BASE = '/api';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadLatestSynthesis();
        });

        // Listen for tab changes
        window.addEventListener('tabchange', (e) => {
            if (e.detail.tab === 'themes') {
                loadThemes();
            }
        });

        // Load status overview
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/synthesis/status/overview`);
                const data = await response.json();

                // Update KPI cards
                document.getElementById('content-24h').textContent = data.total_content_24h || 0;
                document.getElementById('content-7d').textContent = data.total_content_7d || 0;

                if (data.latest_synthesis) {
                    const synthTime = parseUTCDate(data.latest_synthesis.generated_at);
                    document.getElementById('last-synthesis-time').textContent = formatTimeAgo(synthTime);
                    document.getElementById('last-synthesis-window').textContent = data.latest_synthesis.time_window + ' window';
                    document.getElementById('hero-last-updated').textContent = formatTimeAgo(synthTime);
                } else {
                    document.getElementById('last-synthesis-time').textContent = 'Never';
                    document.getElementById('last-synthesis-window').textContent = '-';
                }

                // Update source status list
                const sourceList = document.getElementById('source-status-list');
                if (data.sources_status && data.sources_status.length > 0) {
                    sourceList.innerHTML = data.sources_status.map(source => `
                        <div class="source-item">
                            <div class="source-icon ${source.name.toLowerCase().replace(' ', '')}">${source.name.charAt(0)}</div>
                            <div class="source-info">
                                <div class="source-name">${source.name}</div>
                                <div class="source-count">${source.items_24h} (24h) | ${source.items_7d} (7d)</div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Load latest synthesis
        async function loadLatestSynthesis() {
            try {
                const response = await fetch(`${API_BASE}/synthesis/latest`);
                const data = await response.json();

                if (data.status === 'not_found') {
                    showEmptySynthesis();
                    return;
                }

                displaySynthesis(data);

            } catch (error) {
                console.error('Error loading synthesis:', error);
                showEmptySynthesis();
            }
        }

        // Display synthesis content
        function displaySynthesis(data) {
            document.getElementById('synthesis-empty').style.display = 'none';
            document.getElementById('synthesis-content').style.display = 'block';

            // Check version
            const isV3 = data.version === '3.0' || data.confluence_zones || data.attention_priorities;

            // Update meta info
            document.getElementById('synthesis-window').textContent = data.time_window;
            document.getElementById('synthesis-count').textContent = data.content_count;
            document.getElementById('synthesis-time').textContent = data.generated_at ? formatDateTime(parseUTCDate(data.generated_at)) : '-';

            // Update hero section
            let regimeValue = data.market_regime;
            if (typeof regimeValue === 'object' && regimeValue !== null) {
                regimeValue = regimeValue.current;
            }
            if (regimeValue) {
                const heroRegimeBadge = document.getElementById('hero-regime-badge');
                heroRegimeBadge.className = `regime-badge regime-badge-${regimeValue.toLowerCase().replace(/[^a-z]/g, '-')}`;
                document.getElementById('hero-regime-text').textContent = regimeValue;

                const regimeClass = `regime-${regimeValue.replace('_', '-').replace(' ', '-')}`;
                document.getElementById('market-regime-badge').innerHTML = `<span class="market-regime ${regimeClass}">${regimeValue}</span>`;
            }

            // Update hero key insight
            const execSummary = data.executive_summary;
            if (execSummary) {
                const insight = execSummary.synthesis_narrative || execSummary.narrative || '';
                document.getElementById('hero-key-insight').textContent = insight.split('.')[0] + '.';
            }

            // Synthesis text
            const synthText = document.getElementById('synthesis-text');
            const synthesisContent = data.synthesis_summary || data.synthesis || '';
            const paragraphs = synthesisContent.split('\n\n').filter(p => p.trim());
            synthText.innerHTML = paragraphs.map(p => `<p style="margin-bottom: var(--spacing-sm);">${p}</p>`).join('');

            // Theme tags
            const themeTags = document.getElementById('theme-tags');
            const themes = data.key_themes || [];
            if (themes.length > 0) {
                themeTags.innerHTML = themes.map(theme =>
                    `<span class="badge" style="background: var(--glass-bg); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-full); font-size: var(--text-xs);">${theme}</span>`
                ).join('');
            }

            // Handle V3 content
            if (isV3) {
                document.getElementById('v3-content').style.display = 'block';
                document.getElementById('synthesis-text').style.display = 'none';
                document.getElementById('theme-tags').style.display = 'none';

                displayV3ExecutiveSummary(data.executive_summary || {});
                displayV3AttentionPriorities(data.attention_priorities || []);
                displayV3ConfluenceZones(data.confluence_zones || []);
                displayV3ConflictWatch(data.conflict_watch || []);
                displayV3SourceStances(data.source_stances || {});
            }
        }

        // V3: Display executive summary
        function displayV3ExecutiveSummary(summary) {
            const container = document.getElementById('v3-executive-section');
            if (!summary || (!summary.narrative && !summary.synthesis_narrative)) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const tone = summary.overall_tone || 'uncertain';
            const isEnhanced = summary.source_highlights || summary.synthesis_narrative;

            if (isEnhanced) {
                const macroContext = summary.macro_context || '';
                const synthesisNarrative = summary.synthesis_narrative || '';
                const keyTakeaways = summary.key_takeaways || [];

                container.innerHTML = `
                    ${macroContext ? `<div style="font-size: var(--text-lg); margin-bottom: var(--spacing-md); color: var(--text-primary);">${macroContext}</div>` : ''}
                    ${synthesisNarrative ? `<div style="color: var(--text-secondary); line-height: var(--leading-relaxed);">${synthesisNarrative}</div>` : ''}
                    ${keyTakeaways.length > 0 ? `
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg);">
                            <div style="font-weight: var(--font-semibold); margin-bottom: var(--spacing-sm);">Key Takeaways</div>
                            <ol style="margin: 0; padding-left: var(--spacing-lg);">
                                ${keyTakeaways.map(t => `<li style="margin-bottom: var(--spacing-xs);">${t}</li>`).join('')}
                            </ol>
                        </div>
                    ` : ''}
                    <div style="margin-top: var(--spacing-md);">
                        <span class="badge" style="background: var(--${tone === 'bullish' ? 'success' : tone === 'bearish' ? 'danger' : 'warning'}); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-full); font-size: var(--text-xs);">${tone}</span>
                    </div>
                `;
            } else {
                container.innerHTML = `<div style="color: var(--text-secondary);">${summary.narrative}</div>`;
            }
        }

        // V3: Display attention priorities
        function displayV3AttentionPriorities(priorities) {
            const container = document.getElementById('v3-priorities-list');
            const section = document.getElementById('priorities-section');

            if (!priorities || priorities.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = priorities.map(p => `
                <div style="display: flex; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm);">
                    <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-weight: var(--font-bold); flex-shrink: 0;">${p.rank || '?'}</div>
                    <div>
                        <div style="font-weight: var(--font-semibold);">${p.focus_area || 'Untitled'}</div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">${p.why || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // V3: Display confluence zones
        function displayV3ConfluenceZones(zones) {
            const container = document.getElementById('v3-confluence-list');
            const section = document.getElementById('confluence-section');

            if (!zones || zones.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = zones.map(zone => {
                const strength = zone.confluence_strength || 0;
                const aligned = zone.sources_aligned || [];
                return `
                    <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--success);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-semibold);">${zone.theme || 'Untitled'}</span>
                            <span style="font-size: var(--text-sm); color: var(--success);">${Math.round(strength * 100)}% alignment</span>
                        </div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                            ${aligned.map(s => `<div><strong>${s.source}:</strong> ${s.view}</div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // V3: Display conflict watch
        function displayV3ConflictWatch(conflicts) {
            const container = document.getElementById('v3-conflict-list');
            const section = document.getElementById('conflict-section');

            if (!conflicts || conflicts.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = conflicts.map(c => `
                <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--warning);">
                    <div style="font-weight: var(--font-semibold); margin-bottom: var(--spacing-sm);">${c.topic || 'Untitled'}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); font-size: var(--text-sm);">
                        <div style="padding: var(--spacing-sm); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md);">
                            <div style="color: var(--success); font-weight: var(--font-medium);">Bull Case</div>
                            <div style="color: var(--text-secondary);">${c.bull_case?.view || '-'}</div>
                        </div>
                        <div style="padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
                            <div style="color: var(--danger); font-weight: var(--font-medium);">Bear Case</div>
                            <div style="color: var(--text-secondary);">${c.bear_case?.view || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // V3: Display source stances
        function displayV3SourceStances(stances) {
            const container = document.getElementById('v3-stances-list');
            const section = document.getElementById('stances-section');

            if (!stances || Object.keys(stances).length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            container.innerHTML = Object.entries(stances).map(([name, data]) => {
                const bias = data.overall_bias || 'neutral';
                const biasColor = bias === 'bullish' ? 'success' : bias === 'bearish' ? 'danger' : 'warning';
                return `
                    <div style="padding: var(--spacing-md); background: var(--glass-bg-light); border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                            <span style="font-weight: var(--font-semibold);">${name}</span>
                            <span class="badge" style="background: var(--${biasColor}); color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px;">${bias}</span>
                        </div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">${data.current_stance_narrative || ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Show empty synthesis state
        function showEmptySynthesis() {
            document.getElementById('synthesis-empty').style.display = 'block';
            document.getElementById('synthesis-content').style.display = 'none';
        }

        // Trigger collection
        async function triggerCollection(sourceName) {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="icon">‚è≥</span><span>Collecting...</span>';

            try {
                const response = await fetch(`${API_BASE}/collect/trigger/${sourceName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (response.ok) {
                    btn.innerHTML = `<span class="icon">‚úì</span><span>Done (${data.saved || 0} new)</span>`;
                    await loadStatus();
                    setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed');
                }
            } catch (error) {
                console.error('Collection error:', error);
                btn.innerHTML = '<span class="icon">‚úï</span><span>Error</span>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // Analyze content
        async function analyzeContent() {
            const btn = document.getElementById('btn-analyze');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            let totalAnalyzed = 0;

            try {
                while (true) {
                    btn.innerHTML = `<span class="icon">‚ö°</span><span class="btn-text">Analyzing... (${totalAnalyzed})</span>`;
                    const response = await fetch(`${API_BASE}/analyze/classify-batch?limit=50`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail);
                    if (data.count > 0) {
                        totalAnalyzed += data.count;
                    } else {
                        break;
                    }
                }
                btn.innerHTML = `<span class="icon">‚úì</span><span class="btn-text">Done (${totalAnalyzed})</span>`;
                await loadStatus();
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                console.error('Analysis error:', error);
                btn.innerHTML = '<span class="icon">‚úï</span><span class="btn-text">Error</span>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // Generate synthesis
        async function generateSynthesis(timeWindow) {
            const btn = timeWindow === '24h' ? document.getElementById('btn-generate-24h') : document.getElementById('btn-generate-7d');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="icon">‚è≥</span><span class="btn-text">Generating...</span>`;

            try {
                const response = await fetch(`${API_BASE}/synthesis/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ time_window: timeWindow })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    await loadLatestSynthesis();
                    await loadStatus();
                    btn.innerHTML = `<span class="icon">‚úì</span><span class="btn-text">Done</span>`;
                } else if (data.status === 'no_content') {
                    alert(data.message || 'No content available');
                    btn.innerHTML = originalHTML;
                } else {
                    throw new Error(data.detail || 'Failed');
                }
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } catch (error) {
                console.error('Generation error:', error);
                btn.innerHTML = '<span class="icon">‚úï</span><span class="btn-text">Error</span>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 3000);
            } finally {
                btn.disabled = false;
            }
        }

        // =====================================================
        // THEMES TAB
        // =====================================================
        let allThemes = [];
        let currentThemeFilter = 'all';

        async function loadThemes() {
            try {
                const summaryResponse = await fetch(`${API_BASE}/themes/summary`);
                const summary = await summaryResponse.json();

                document.getElementById('themes-total').textContent = summary.total || 0;
                document.getElementById('themes-active').textContent = summary.by_status?.active || 0;
                document.getElementById('themes-emerging').textContent = summary.by_status?.emerging || 0;
                document.getElementById('themes-evolved').textContent = summary.by_status?.evolved || 0;
                document.getElementById('kpi-themes').textContent = summary.by_status?.active || 0;

                const themesResponse = await fetch(`${API_BASE}/themes`);
                allThemes = await themesResponse.json();
                displayThemes(allThemes);

            } catch (error) {
                console.error('Error loading themes:', error);
            }
        }

        function filterThemes(status, btnEl) {
            currentThemeFilter = status;
            document.querySelectorAll('#panel-themes .tabs-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');

            let filtered = status === 'all' ? allThemes : allThemes.filter(t => t.status === status);
            displayThemes(filtered);
        }

        function displayThemes(themes) {
            const container = document.getElementById('themes-list');
            if (!themes || themes.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-card" style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìã</div>
                        <h3>No Themes Found</h3>
                        <p style="color: var(--text-muted);">${currentThemeFilter === 'all' ? 'Themes will be extracted from synthesis.' : `No ${currentThemeFilter} themes.`}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = themes.map(theme => {
                const statusColor = theme.status === 'active' ? 'success' : theme.status === 'emerging' ? 'warning' : theme.status === 'evolved' ? 'primary' : 'text-muted';
                return `
                    <div class="sidebar-card" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-semibold);">${theme.name}</span>
                            <span class="badge" style="background: var(--${statusColor}); color: white; padding: 2px 8px; border-radius: var(--radius-full); font-size: 10px;">${theme.status}</span>
                        </div>
                        ${theme.description ? `<p style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--spacing-sm);">${theme.description}</p>` : ''}
                        <div style="font-size: var(--text-xs); color: var(--text-muted);">
                            Evidence: ${theme.evidence_count || 0} items
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================
        // UTILITIES
        // =====================================================
        function parseUTCDate(isoString) {
            if (!isoString) return null;
            if (!isoString.endsWith('Z') && !isoString.includes('+') && !isoString.includes('-', 10)) {
                isoString = isoString + 'Z';
            }
            return new Date(isoString);
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function formatDateTime(date) {
            if (!date) return '-';
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
    </script>

    <!-- Navigation & UI Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/accessibility.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/toast.js"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Chart Component Scripts -->
    <script src="js/charts/chartConfig.js"></script>
    <script src="js/charts/confluenceRadar.js"></script>
    <script src="js/charts/sourceDonut.js"></script>
    <script src="js/charts/themeTimeline.js"></script>
    <script src="js/charts/sentimentGauge.js"></script>
    <script src="js/charts/convictionBar.js"></script>
    <script src="js/charts/confluenceHeatmap.js"></script>
    <script src="js/charts/index.js"></script>
</body>
</html>
