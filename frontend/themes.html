<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Tracker - Macro Confluence Hub</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">Macro Confluence Hub</a>
            <nav class="nav" id="main-nav">
                <a href="index.html">Today</a>
                <a href="simple.html">Synthesis</a>
                <a href="themes.html" class="active">Themes</a>
                <a href="sources.html">Sources</a>
                <a href="matrix.html">Matrix</a>
                <a href="heatmap.html">Heatmap</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="flex-between mb-lg">
            <h1 class="section-title">Theme Tracker</h1>
            <div class="flex gap-md">
                <select id="status-filter" class="btn btn-secondary" onchange="applyFilters()">
                    <option value="">All Statuses</option>
                    <option value="active" selected>Active</option>
                    <option value="acted_upon">Acted Upon</option>
                    <option value="invalidated">Invalidated</option>
                    <option value="archived">Archived</option>
                </select>
                <select id="conviction-filter" class="btn btn-secondary" onchange="applyFilters()">
                    <option value="">All Convictions</option>
                    <option value="0.75">High (>=75%)</option>
                    <option value="0.5">Medium (>=50%)</option>
                    <option value="0.25">Low (>=25%)</option>
                </select>
            </div>
        </div>

        <!-- Themes List -->
        <div id="themes-container">
            <div class="loading">Loading themes...</div>
        </div>

        <!-- Theme Detail Modal (Simple overlay) -->
        <div id="theme-detail-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 20px;">
            <div style="max-width: 900px; margin: 0 auto; background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--spacing-xl);">
                <div class="flex-between mb-lg">
                    <h2 id="modal-title"></h2>
                    <button class="btn btn-secondary btn-sm" onclick="closeModal()">Close</button>
                </div>
                <div id="modal-content"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // ====================================================================
        // Theme Tracker Logic
        // ====================================================================

        let allThemes = [];
        let currentThemeId = null;

        /**
         * Load all themes with filters
         */
        async function loadThemes() {
            const statusFilter = document.getElementById('status-filter').value;
            const convictionFilter = document.getElementById('conviction-filter').value;

            try {
                showLoading('themes-container');

                allThemes = await getThemes(
                    statusFilter || null,
                    convictionFilter ? parseFloat(convictionFilter) : null
                );

                renderThemes(allThemes);

                // If URL has theme ID, show detail
                const urlParams = new URLSearchParams(window.location.search);
                const themeId = urlParams.get('id');
                if (themeId) {
                    showThemeDetail(parseInt(themeId));
                }

            } catch (error) {
                console.error('Error loading themes:', error);
                showError('themes-container', 'Failed to load themes. Check console for details.');
            }
        }

        /**
         * Render themes list
         */
        function renderThemes(themes) {
            const container = document.getElementById('themes-container');

            if (!themes || themes.length === 0) {
                showEmpty('themes-container', 'No themes match your filters');
                return;
            }

            const html = themes.map(theme => `
                <div class="card" style="cursor: pointer;" onclick="showThemeDetail(${theme.id})">
                    <div class="flex-between mb-md">
                        <div>
                            <h3 class="card-title">${theme.name}</h3>
                            <p class="card-subtitle">${formatDate(theme.first_mentioned)} • Updated ${formatDate(theme.updated_at)}</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="stat-value ${getConvictionClass(theme.conviction)}" style="font-size: 32px;">
                                ${formatConviction(theme.conviction)}
                            </div>
                            <span class="badge ${getStatusClass(theme.status)}">${theme.status}</span>
                        </div>
                    </div>

                    ${theme.description ? `<p class="text-secondary mb-md">${truncate(theme.description, 200)}</p>` : ''}

                    <div class="flex gap-md">
                        <span class="text-secondary">
                            <strong>${theme.evidence_count}</strong> evidence sources
                        </span>
                        ${theme.confidence_interval && theme.confidence_interval[0] ?
                            `<span class="text-secondary">
                                Confidence: ${formatConviction(theme.confidence_interval[0])} - ${formatConviction(theme.confidence_interval[1])}
                            </span>` : ''}
                        ${theme.last_update ?
                            `<span class="text-secondary">
                                Last update: ${formatConviction(theme.last_update.prior)} → ${formatConviction(theme.last_update.posterior)}
                            </span>` : ''}
                    </div>

                    <div class="mt-md flex gap-sm">
                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); updateStatus(${theme.id}, 'acted_upon')">
                            Mark Acted Upon
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); updateStatus(${theme.id}, 'invalidated')">
                            Invalidate
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewHistorical(${theme.id})">
                            View History
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        /**
         * Show theme detail modal
         */
        async function showThemeDetail(themeId) {
            currentThemeId = themeId;

            try {
                const theme = await getThemeDetail(themeId);

                document.getElementById('modal-title').textContent = theme.name;

                const html = `
                    <div class="mb-lg">
                        <div class="stat-row">
                            <div class="stat">
                                <div class="stat-label">Conviction</div>
                                <div class="stat-value ${getConvictionClass(theme.conviction)}">
                                    ${formatConviction(theme.conviction)}
                                </div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Evidence Count</div>
                                <div class="stat-value">${theme.evidence.length}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Status</div>
                                <div class="stat-value">
                                    <span class="badge ${getStatusClass(theme.status)}">${theme.status}</span>
                                </div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">First Mentioned</div>
                                <div class="stat-value" style="font-size: 16px;">${formatDate(theme.first_mentioned)}</div>
                            </div>
                        </div>
                    </div>

                    ${theme.description ? `
                        <div class="mb-lg">
                            <h3 class="mb-sm">Description</h3>
                            <p class="text-secondary">${theme.description}</p>
                        </div>
                    ` : ''}

                    <div class="mb-lg">
                        <h3 class="mb-sm">Supporting Evidence (${theme.evidence.length})</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Strength</th>
                                    <th>Sentiment</th>
                                    <th>Date</th>
                                    <th>Support</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${theme.evidence.map(ev => `
                                    <tr>
                                        <td><span class="badge badge-info">${ev.source}</span></td>
                                        <td>${formatConviction(ev.evidence_strength)}</td>
                                        <td><span class="badge ${getSentimentClass(ev.sentiment)}">${ev.sentiment || 'N/A'}</span></td>
                                        <td>${formatDate(ev.added_at)}</td>
                                        <td>${ev.supports_theme ? '✓' : '✗'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${theme.bayesian_history && theme.bayesian_history.length > 0 ? `
                        <div class="mb-lg">
                            <h3 class="mb-sm">Bayesian Update History (${theme.bayesian_history.length})</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Prior</th>
                                        <th>Posterior</th>
                                        <th>Change</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${theme.bayesian_history.reverse().map(update => `
                                        <tr>
                                            <td>${formatDateTime(update.date)}</td>
                                            <td>${formatConviction(update.prior)}</td>
                                            <td>${formatConviction(update.posterior)}</td>
                                            <td class="${update.posterior > update.prior ? 'text-success' : 'text-danger'}">
                                                ${update.posterior > update.prior ? '+' : ''}${Math.round((update.posterior - update.prior) * 100)}%
                                            </td>
                                            <td class="text-secondary">${truncate(update.reason || 'N/A', 50)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}

                    <div class="flex gap-md">
                        <button class="btn btn-success" onclick="updateStatusFromModal('acted_upon')">
                            Mark Acted Upon
                        </button>
                        <button class="btn btn-danger" onclick="updateStatusFromModal('invalidated')">
                            Invalidate Theme
                        </button>
                        <button class="btn btn-primary" onclick="viewHistorical(${theme.id})">
                            View Historical Chart
                        </button>
                    </div>
                `;

                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('theme-detail-modal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading theme detail:', error);
                alert('Failed to load theme details');
            }
        }

        /**
         * Close modal
         */
        function closeModal() {
            document.getElementById('theme-detail-modal').classList.add('hidden');
            currentThemeId = null;
        }

        /**
         * Update theme status
         */
        async function updateStatus(themeId, status) {
            try {
                await updateThemeStatus(themeId, status);
                loadThemes(); // Reload list
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update theme status');
            }
        }

        /**
         * Update status from modal
         */
        async function updateStatusFromModal(status) {
            if (!currentThemeId) return;

            try {
                await updateThemeStatus(currentThemeId, status);
                closeModal();
                loadThemes();
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update theme status');
            }
        }

        /**
         * View historical chart
         */
        function viewHistorical(themeId) {
            window.location.href = `historical.html?id=${themeId}`;
        }

        /**
         * Apply filters
         */
        function applyFilters() {
            loadThemes();
        }

        // Load themes on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadThemes();

            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        });
    </script>
</body>
</html>
