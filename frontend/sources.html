<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Browser - Macro Confluence Hub</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">Macro Confluence Hub</a>
            <nav class="nav" id="main-nav">
                <a href="index.html">Today</a>
                <a href="simple.html">Synthesis</a>
                <a href="themes.html">Themes</a>
                <a href="sources.html" class="active">Sources</a>
                <a href="matrix.html">Matrix</a>
                <a href="heatmap.html">Heatmap</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <h1 class="section-title">Source Browser</h1>

        <!-- Source Selection -->
        <div class="card mb-lg">
            <div class="card-header">
                <h2 class="card-title">Select Source</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-3" id="sources-grid">
                    <div class="loading">Loading sources...</div>
                </div>
            </div>
        </div>

        <!-- Content List -->
        <div id="content-section" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title" id="source-name"></h2>
                        <p class="card-subtitle" id="source-stats"></p>
                    </div>
                    <div class="flex gap-sm">
                        <button class="btn btn-secondary btn-sm" onclick="loadPreviousPage()" id="btn-prev">Previous</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadNextPage()" id="btn-next">Next</button>
                    </div>
                </div>
                <div class="card-body" id="content-list">
                    <div class="loading">Loading content...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // ====================================================================
        // Source Browser Logic
        // ====================================================================

        let currentSource = null;
        let currentPage = 0;
        const itemsPerPage = 50;

        /**
         * Load all sources
         */
        async function loadSources() {
            try {
                const sources = await getSources();
                renderSourcesGrid(sources);
            } catch (error) {
                console.error('Error loading sources:', error);
                showError('sources-grid', 'Failed to load sources');
            }
        }

        /**
         * Render sources grid
         */
        function renderSourcesGrid(sources) {
            const container = document.getElementById('sources-grid');

            if (!sources || sources.length === 0) {
                showEmpty('sources-grid', 'No sources configured');
                return;
            }

            const html = sources.map(source => `
                <div class="card" style="cursor: pointer; padding: var(--spacing-md);"
                     onclick="selectSource('${source.name}')">
                    <div class="flex-between mb-sm">
                        <h3 style="font-size: 16px; font-weight: 600;">${source.name}</h3>
                        <span class="badge ${source.active ? 'badge-success' : 'badge-neutral'}">
                            ${source.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <p class="text-secondary" style="font-size: 13px; margin-bottom: 8px;">
                        ${source.type}
                    </p>
                    <div class="flex gap-md" style="font-size: 13px;">
                        <span class="text-secondary">${source.total_items} items</span>
                        <span class="text-secondary">${source.analyzed_items} analyzed</span>
                    </div>
                    <p class="text-secondary mt-xs" style="font-size: 12px;">
                        Last: ${formatDate(source.last_collected)}
                    </p>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        /**
         * Select a source and load its content
         */
        async function selectSource(sourceName) {
            currentSource = sourceName;
            currentPage = 0;

            document.getElementById('content-section').classList.remove('hidden');
            document.getElementById('source-name').textContent = sourceName;

            loadContent();
        }

        /**
         * Load content for current source
         */
        async function loadContent() {
            if (!currentSource) return;

            try {
                showLoading('content-list');

                const offset = currentPage * itemsPerPage;
                const data = await getSourceContent(currentSource, itemsPerPage, offset);

                // Update stats
                document.getElementById('source-stats').textContent =
                    `Showing ${offset + 1}-${Math.min(offset + itemsPerPage, data.pagination.total)} of ${data.pagination.total} items`;

                // Update pagination buttons
                document.getElementById('btn-prev').disabled = offset === 0;
                document.getElementById('btn-next').disabled = !data.pagination.has_more;

                renderContent(data.content);

            } catch (error) {
                console.error('Error loading content:', error);
                showError('content-list', 'Failed to load content');
            }
        }

        /**
         * Render content list
         */
        function renderContent(content) {
            const container = document.getElementById('content-list');

            if (!content || content.length === 0) {
                showEmpty('content-list', 'No content from this source');
                return;
            }

            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Collected</th>
                            <th>Analysis</th>
                            <th>Confluence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td>
                                    <span class="badge badge-info">${item.content_type}</span>
                                    ${item.processed ? '<span class="badge badge-success">Processed</span>' : ''}
                                </td>
                                <td>${formatDateTime(item.collected_at)}</td>
                                <td>
                                    ${item.analysis ? `
                                        <div style="font-size: 13px;">
                                            <div class="mb-xs">
                                                <span class="badge badge-info">${item.analysis.agent_type}</span>
                                            </div>
                                            ${item.analysis.sentiment ?
                                                `<span class="badge ${getSentimentClass(item.analysis.sentiment)}">${item.analysis.sentiment}</span>` : ''}
                                            ${item.analysis.conviction ?
                                                `<span class="text-secondary">Conv: ${item.analysis.conviction}/10</span>` : ''}
                                            ${item.analysis.key_themes && item.analysis.key_themes.length > 0 ?
                                                `<div class="mt-xs text-secondary">${truncate(item.analysis.key_themes.join(', '), 80)}</div>` : ''}
                                        </div>
                                    ` : '<span class="text-secondary">Not analyzed</span>'}
                                </td>
                                <td>
                                    ${item.confluence ? `
                                        <div>
                                            <div><strong>${item.confluence.total_score}/14</strong></div>
                                            <div class="text-secondary" style="font-size: 13px;">
                                                Core: ${item.confluence.core_score}/10
                                            </div>
                                            ${item.confluence.meets_threshold ?
                                                '<span class="badge badge-success">Threshold Met</span>' : ''}
                                        </div>
                                    ` : '<span class="text-secondary">Not scored</span>'}
                                </td>
                                <td>
                                    ${item.url ?
                                        `<a href="${item.url}" target="_blank" class="btn btn-secondary btn-sm">View</a>` :
                                        item.file_path ?
                                        `<button class="btn btn-secondary btn-sm" onclick="alert('File: ${item.file_path}')">File</button>` :
                                        '<span class="text-secondary">N/A</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        /**
         * Load next page
         */
        function loadNextPage() {
            currentPage++;
            loadContent();
        }

        /**
         * Load previous page
         */
        function loadPreviousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadContent();
            }
        }

        // Load sources on page load
        document.addEventListener('DOMContentLoaded', loadSources);
    </script>
</body>
</html>
